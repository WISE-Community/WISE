{"version":3,"sources":["conceptMapService.es6"],"names":["ConceptMapService","$anchorScroll","$filter","$location","$q","$timeout","ConfigService","StudentAssetService","StudentDataService","UtilService","$translate","component","type","width","height","background","stretchBackground","nodes","linksTitle","links","rules","starterConceptMap","customRuleEvaluator","showAutoScore","showAutoFeedback","showNodeLabels","componentStates","componentEvents","nodeEvents","node","result","length","submitRequired","showSubmitButton","showSaveButton","i","l","state","isSubmit","studentData","submitCounter","componentState","conceptMapData","draw","id","originalId","filePath","label","x","y","showLabel","ConceptMapNode","sourceNode","destinationNode","color","curvature","startCurveUp","startCurveDown","ConceptMapLink","x1","y1","x2","y2","slope","distance","Math","sqrt","pow","startx","starty","endx","endy","endCurveUp","len","angle","nodeRadius","start","coord","tip","pathData","arrowHeadData","curveDistance","startYCurveDistance","max","min","endYCurveDistance","startUp","endUp","c2","c3","cDistance","perimX","perimYstart","perimYend","push","percLengthOfHead","getLengthOfCubicBezier","centerBaseOfHead","getPointOnCubicBezier","theta","atan2","baseAngleA","PI","baseAngleB","baseA","cos","sin","baseB","round","C1","C2","C3","C4","precision","t","currentPoint","previousPoint","xDif","yDif","percent","pos","B1","B2","B3","B4","componentContent","ruleName","rule","getRuleByRuleName","getRulesByCategoryName","firstRule","r","tempRule","tempResult","evaluateRule","nodeLabel","getNodesByLabel","nodeCount","comparison","number","not","linkLabel","otherNodeLabel","getLinksByLabels","linkCount","name","category","tempRules","categories","c","tempCategory","nodesByLabel","n","resultLinks","tempLink","tempLinkLabel","sourceNodeLabel","destinationNodeLabel","args","ruleResult","evaluateRuleByRuleName","conceptMapNodes","instanceId","fileName","conceptMapNode","newConceptMapNode","conceptMapLinks","link","sourceNodeId","sourceNodeInstanceId","destinationNodeId","destinationNodeInstanceId","getNodeById","conceptMapLink","newConceptMapLink","moveLinkTextToFront","moveNodesToFront","refreshLinkLabels","moveTextGroupToFront","group","getGroup","front","getLabel","setLabel","tempNode","tempNodeId","getId","deferred","defer","svgElement","document","createElement","SVG","populateConceptMapData","svgString","innerHTML","getHrefToBase64ImageReplacements","then","images","imagePair","imageHref","lastIndexOfSlash","lastIndexOf","substring","base64Image","imageRegEx","RegExp","replace","myCanvas","ctx","getContext","svg","Blob","domURL","self","URL","webkitURL","url","createObjectURL","image","Image","thisUtilService","onload","event","target","drawImage","toDataURL","imageObject","getImageObjectFromBase64String","uploadAsset","unreferencedAsset","copyAssetForReference","referencedAsset","referencedAssetUrl","deleteAsset","resolve","src","promise","prependAssetsPath","promises","imageHrefs","getImagesInSVG","getProjectAssetsDirectoryPath","getBase64Image","all","regex","exec","isStudentConceptMapDifferentThanStarterConceptMap","studentConceptMap","studentNodes","studentLinks","starterNodes","starterLinks","studentNode","starterNode","studentLink","starterLink","sourceNodeOriginalId","destinationNodeOriginalId","angular","element","nodeId","componentId","serializer","XMLSerializer","serializeToString","asset","objects","prefix","nextAvailableNumber","usedNumbers","object","objectId","objectIdNumber","parseInt","maxNumberUsed","apply","isNaN","ComponentService","highlighted","deleteButtonColor","connector","createConnector","deleteButtonGroup","createDeleteButtonGroup","border","createBorder","outgoingLinks","incomingLinks","add","textGroup","createTextGroup","hide","jsonObject","ol","outgoingLink","getOriginalId","tempLinkObject","il","incomingLink","rect","fill","stroke","opacity","connectorRadius","circle","radius","cx","cy","deleteButtonRadius","deleteButtonCircle","topX","topY","bottomX","bottomY","leftX","leftY","rightX","rightY","deleteButtonXPath","deleteButtonX","path","transform","rotation","translate","attr","textRect","text","font","family","size","style","setAttribute","textBBox","getBBox","calculateTextRectWidth","e","getImageWidth","getImageHeight","groupId","val","groupX","imageCX","groupY","imageCY","value","show","getGroupX","imageRelativeX","imageX","bbox","bboxX","getGroupY","imageRelativeY","imageY","bboxY","nodeMouseOverFunction","mouseover","nodeMouseOutFunction","mouseout","nodeMouseDownFunction","mousedown","nodeMouseUpFunction","mouseup","nodeMouseClickFunction","click","connectorMouseDownFunction","deleteButtonMouseDownFunction","deleteButtonMouseOverFunction","deleteButtonMouseOutFunction","dragMoveFunction","on","tempOutgoingLink","splice","tempIncomingLink","nearestPoint","getNearestPointToDestinationNode","updateCoordinates","controller","studentDataChanged","draggable","remove","linksToDestination","labelText","head","textPercentageLocationOnLink","randInt","floor","random","curvedLink","connectLinkToNodes","arrowPathArraysObject","calculateCurvedLine","tail","toString","hideTextGroup","showTextGroup","isDragging","array","plot","deleteButtonLocation","getDeleteButtonLocation","totalLength","getTotalLength","midPoint","getPointAtLength","arrowPathArrays","directionAlreadyUsed","direction","parallelLinks","getLinksToDestination","usedDirections","p","parallelLink","tempDirection","indexOf","hideDeleteButton","rectMinX","getImageX","rectMinY","getImageY","point","getNearestPointInPerimeter","w","h","b","clamp","dl","abs","dr","dt","db","m","lower","upper","deleteButton","addOutgoingLink","addIncomingLink","invisibleCircleRadius","invisibleCircle","deleteButtonMidpointX","deleteButtonMidpointY","rotate","location","deleteButtonGroupMouseOver","deleteButtonGroupMouseOut","showDeleteButton","deleteButtonClickedFunction","linkMouseDownFunction","linkTextMouseDownFunction","linkMouseOverFunction","linkMouseOutFunction","line","distanceAlongLine","distanceAlongNormal","p1","p2","scale","dx","dy","occluded","linkGroupId","removeOutgoingLink","removeIncomingLink","$inject"],"mappings":"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","file":"conceptMapService.js","sourcesContent":["import ComponentService from '../componentService';\n\nclass ConceptMapService extends ComponentService {\n  constructor(\n      $anchorScroll,\n      $filter,\n      $location,\n      $q,\n      $timeout,\n      ConfigService,\n      StudentAssetService,\n      StudentDataService,\n      UtilService) {\n    super($filter, StudentDataService, UtilService);\n    this.$anchorScroll = $anchorScroll;\n    this.$location = $location;\n    this.$q = $q;\n    this.$timeout = $timeout;\n    this.ConfigService = ConfigService;\n    this.StudentAssetService = StudentAssetService;\n  }\n\n  getComponentTypeLabel() {\n    return this.$translate('conceptMap.componentTypeLabel');\n  }\n\n  createComponent() {\n    const component = super.createComponent();\n    component.type = 'ConceptMap';\n    component.width = 800;\n    component.height = 600;\n    component.background = null;\n    component.stretchBackground = null;\n    component.nodes = [];\n    component.linksTitle = '';\n    component.links = [];\n    component.rules = [];\n    component.starterConceptMap = null;\n    component.customRuleEvaluator = '';\n    component.showAutoScore = false;\n    component.showAutoFeedback = false;\n    component.showNodeLabels = true;\n    return component;\n  }\n\n  isCompleted(component, componentStates, componentEvents, nodeEvents, node) {\n    let result = false;\n\n    if (componentStates && componentStates.length) {\n      let submitRequired = node.showSubmitButton || (component.showSubmitButton && !node.showSaveButton);\n\n      if (submitRequired) {\n        // completion requires a submission, so check for isSubmit in any component states\n        for (let i = 0, l = componentStates.length; i < l; i++) {\n          let state = componentStates[i];\n          if (state.isSubmit && state.studentData) {\n            // component state is a submission\n            if (state.isSubmit == true || (state.studentData.submitCounter != null && state.studentData.submitCounter > 0)) {\n              // there is a response so the component is completed\n              result = true;\n              break;\n            }\n          }\n        }\n      } else {\n        // get the last component state\n        let l = componentStates.length - 1;\n        let componentState = componentStates[l];\n\n        let studentData = componentState.studentData;\n\n        if (studentData != null) {\n          if (studentData.conceptMapData != null) {\n            // there is a response so the component is completed\n            result = true;\n          }\n        }\n      }\n    }\n\n    return result;\n  };\n\n  /**\n   * Create an instance of the ConceptMapNode class\n   * @param draw the svg.js draw object\n   * @param id the node id\n   * @param filePath the file path of the image\n   * @param label the label of the node\n   * @param x the x coordinate\n   * @param y the y coordinate\n   * @param width the width of the image\n   * @param height the height of the image\n   * @param showLabel whether to show the label\n   * @param a ConceptMapNode\n   */\n  newConceptMapNode(draw, id, originalId, filePath, label, x, y, width, height, showLabel) {\n    return new ConceptMapNode(this, draw, id, originalId, filePath, label, x, y, width, height, showLabel);\n  }\n\n  /**\n   * Create an instance of the ConceptMapLink class\n   * @param draw the svg.js draw object\n   * @param id the link id\n   * @param node the source ConceptMapNode that the link is coming out of\n   * @param x the x position of the tail\n   * @param y the y position of the tail\n   * @returns a ConceptMapLink\n   */\n  newConceptMapLink(draw, id, originalId, sourceNode, destinationNode, label, color, curvature, startCurveUp, startCurveDown) {\n    return new ConceptMapLink(this, draw, id, originalId, sourceNode, destinationNode, label, color, curvature, startCurveUp, startCurveDown);\n  }\n\n  /**\n   * Get the slope of the line between two points\n   * @param x1 x position of the first point\n   * @param y1 y position of the first point\n   * @param x2 x position of the second point\n   * @param y2 y position of the second point\n   * @returns the slope of the line or null if the slope is infinite\n   */\n  getSlope(x1, y1, x2, y2) {\n\n    var slope = null;\n\n    if ((x2 - x1) == 0) {\n      // the slope is infinite so we will return null\n      slope = null;\n    } else {\n      // calculate the slope\n      slope = (y2 - y1) / (x2 - x1);\n    }\n\n    return slope;\n  }\n\n  /**\n   * Calculate the euclidean distance between two points\n   * @param x1 x position of the first point\n   * @param y1 y position of the first point\n   * @param x2 x position of the second point\n   * @param y2 y position of the second point\n   * @returns the distance between the two points\n   */\n  calculateDistance(x1, y1, x2, y2) {\n\n    // calculate the distance\n    var distance = Math.sqrt(Math.pow((x2 - x1), 2) + Math.pow((y2 - y1), 2));\n\n    return distance;\n  }\n\n  /**\n\n  Returns an array representation of the path elements for an arrow\n\n  First we calculate a simple curve for the tail.\n\n  Then we pick a point on that curve to use as the base-center of the arrow head,\n  then calculate the position of that triangle based on the angle between that\n  point and the tip.\n\n  @params startx {Number} X-coordinate of the start point\n  @params starty {Number} Y-coordinate of the start point\n  @params endx {Number} X-coordinate of the end point\n  @params endy {Number} Y-coordinate of the end point\n  @params len {Number} Length of the \"tip\" of the arrowhead\n  @params angle {Number} Angle in degrees\n    between the line and each wing of the arrowhead.\n    Should be less than 90.\n\n  Note: This function and the associated functions that are called by this\n  function are taken from the Concord MySystem github project.\n  https://github.com/concord-consortium/mysystem_sc\n  The code is found in the arrow_drawing.js file.\n  mysystem_sc/apps/my_system/mixins/arrow_drawing.js\n\n  **/\n  arrowPathArrays(startx,starty,endx,endy,startCurveUp,endCurveUp,len,angle,curvature,nodeRadius) {\n\n    if (startx === endx && starty === endy){\n      return [[\"\"],[\"\"]];\n    }\n\n    var start = new this.coord(startx, starty),\n    tip = new this.coord(endx, endy),\n    pathData   = [],\n    arrowHeadData = [];\n\n    // calculate control points c2 and c3\n    var curveDistance = (tip.x - start.x) * curvature,\n    startYCurveDistance = (curveDistance === 0 ? 1 : Math.max(Math.min(curveDistance, 100), -100)),\n    endYCurveDistance = startYCurveDistance,\n    startUp = startCurveUp ? 1 : -1,\n    endUp = endCurveUp ? 1 : -1;\n    startYCurveDistance = (startYCurveDistance * startUp > 0) ? startYCurveDistance : startYCurveDistance * -1;\n    endYCurveDistance = (endYCurveDistance * endUp > 0) ? endYCurveDistance : endYCurveDistance * -1;\n    var c2 = new this.coord(start.x+(curveDistance/2), start.y-startYCurveDistance),\n    c3 = new this.coord(tip.x-(curveDistance/2), tip.y-endYCurveDistance),\n    cDistance = Math.sqrt(Math.pow((curveDistance/2),2) + Math.pow(startYCurveDistance,2)),\n    perimX = nodeRadius*(curveDistance/2)/cDistance,\n    perimYstart = nodeRadius*startYCurveDistance/cDistance,\n    perimYend = nodeRadius*endYCurveDistance/cDistance;\n\n    // update tip\n    tip = new this.coord(tip.x - perimX, tip.y - perimYend);\n\n    // draw arrow path\n\n    pathData.push(\"M\", start.x + perimX, start.y - perimYstart);  // move to start of line\n    pathData.push(\"C\", c2.x, c2.y, c3.x, c3.y, tip.x, tip.y); // curve line to the tip\n\n    // draw arrow head\n    var percLengthOfHead = len / this.getLengthOfCubicBezier(start, c2, c3, tip),\n    centerBaseOfHead = this.getPointOnCubicBezier(percLengthOfHead, start, c2, c3, tip),\n    theta  = Math.atan2((tip.y-centerBaseOfHead.y),(tip.x-centerBaseOfHead.x)),\n    baseAngleA = theta + angle * Math.PI/180,\n    baseAngleB = theta - angle * Math.PI/180,\n    baseA    = new this.coord(tip.x - len * Math.cos(baseAngleA), tip.y - len * Math.sin(baseAngleA)),\n    baseB    = new this.coord(tip.x - len * Math.cos(baseAngleB), tip.y - len * Math.sin(baseAngleB));\n\n    arrowHeadData.push(\"M\", tip.x, tip.y);\n    arrowHeadData.push(\"L\", baseA.x, baseA.y);  // line to baseA\n    arrowHeadData.push(\"L\", baseB.x, baseB.y);  // line to baseB\n    arrowHeadData.push(\"L\", tip.x,   tip.y  );  // line back to the tip\n\n    return [pathData, arrowHeadData];\n  }\n\n  /**\n   * Note: This function is from\n   * https://github.com/concord-consortium/mysystem_sc\n   * The code is found in the arrow_drawing.js file.\n   * mysystem_sc/apps/my_system/mixins/arrow_drawing.js\n   */\n  coord(x,y) {\n    if(!x) x = 0;\n    if(!y) y = 0;\n    /*\n    *   Limit precision of decimals for SVG rendering.\n    *   otherwise we get really long SVG strings,\n    *   and webkit error messsages like of this sort:\n    *   \"Error: Problem parsing d='<svg string with long dec>'\"\n    */\n    x = Math.round(x * 1000)/1000;\n    y = Math.round(y * 1000)/1000;\n    return {x: x, y: y};\n  }\n\n  /**\n   * Note: This function is from\n   * https://github.com/concord-consortium/mysystem_sc\n   * The code is found in the arrow_drawing.js file.\n   * mysystem_sc/apps/my_system/mixins/arrow_drawing.js\n   */\n  getLengthOfCubicBezier(C1,C2,C3,C4)\n  {\n    var precision = 10,\n    length  = 0,\n    t,\n    currentPoint,\n    previousPoint;\n\n    for (var i = 0; i<precision; i++){\n      t = i/precision;\n      currentPoint = this.getPointOnCubicBezier(t, C1,C2,C3,C4);\n      if (i > 0){\n        var xDif = currentPoint.x - previousPoint.x,\n        yDif = currentPoint.y - previousPoint.y;\n        length += Math.sqrt((xDif*xDif) + (yDif*yDif));\n      }\n      previousPoint = currentPoint;\n    }\n    return length;\n  }\n\n  /**\n   * Note: This function is from\n   * https://github.com/concord-consortium/mysystem_sc\n   * The code is found in the arrow_drawing.js file.\n   * mysystem_sc/apps/my_system/mixins/arrow_drawing.js\n   */\n  getPointOnCubicBezier(percent,C1,C2,C3,C4) {\n    if (percent < 0) percent = 0;\n    if (percent > 1) percent = 1;\n    var pos = new this.coord();\n    pos.x = C1.x*this.B1(percent) + C2.x*this.B2(percent) + C3.x*this.B3(percent) + C4.x*this.B4(percent);\n    pos.y = C1.y*this.B1(percent) + C2.y*this.B2(percent) + C3.y*this.B3(percent) + C4.y*this.B4(percent);\n    return pos;\n  }\n\n  /**\n   * Note: These functions are from\n   * https://github.com/concord-consortium/mysystem_sc\n   * The code is found in the arrow_drawing.js file.\n   * mysystem_sc/apps/my_system/mixins/arrow_drawing.js\n   */\n  B1(t) { return t*t*t; }\n  B2(t) { return 3*t*t*(1-t); }\n  B3(t) { return 3*t*(1-t)*(1-t); }\n  B4(t) { return (1-t)*(1-t)*(1-t); }\n\n  /**\n   * Evaluate a rule name\n   * @param componentContent the component content\n   * @param conceptMapData the student concept map data\n   * @param ruleName the rule name\n   * @returns whether the rule was satisfied\n   */\n  evaluateRuleByRuleName(componentContent, conceptMapData, ruleName) {\n\n    var result = false;\n\n    if (ruleName === true) {\n      // the rule name is not actually a rule but is the true boolean\n      return true;\n    } else if (ruleName === false) {\n      // the rule name is not actually a rule but is the false boolean\n      return false;\n    }\n\n    // get the rule\n    var rule = this.getRuleByRuleName(componentContent, ruleName);\n\n    if (rule == null) {\n      /*\n       * we didn't find a rule with the given rule name so we will look\n       * for a category with that name\n       */\n\n      // get the rules that are in the category\n      var rules = this.getRulesByCategoryName(componentContent, ruleName);\n\n      var firstRule = true;\n\n      if (rules != null) {\n\n        /*\n         * loop through all the rules in the category. we will say the\n         * category is satisfied if all the rules in the category\n         * evaluate to true.\n         */\n        for (var r = 0; r < rules.length; r++) {\n          var tempRule = rules[r];\n\n          // evaluate the rule\n          var tempResult = this.evaluateRule(conceptMapData, tempRule);\n\n          if (firstRule) {\n            /*\n             * this is the first rule so we will set the value\n             * of the rule to the result\n             */\n            result = tempResult;\n            firstRule = false;\n          } else {\n            /*\n             * this is not the first rule so we will compute the\n             * \"logical and\" of the result so far and this rule's\n             * result\n             */\n            result = result && tempResult;\n          }\n\n          if (!result) {\n            /*\n             * the result is false so we can short circuit and\n             * stop looping since we have now just found that\n             * one of the rules is not satisfied which means\n             * the category is not satisfied.\n             */\n            break;\n          }\n        }\n      }\n    } else {\n      // evaluate the rule\n      result = this.evaluateRule(conceptMapData, rule);\n    }\n\n    return result;\n  }\n\n  /**\n   * Evaluate a rule\n   * @param conceptMapData the concept map student data\n   * @param rule the rule object\n   * @returns whether the rule was satisfied\n   */\n  evaluateRule(conceptMapData, rule) {\n\n    var result = false;\n\n    if (rule != null) {\n\n      if (rule.type == 'node') {\n        // this is a node rule\n\n        // get the node we are looking for\n        var nodeLabel = rule.nodeLabel;\n\n        // get all the nodes with the given label\n        var nodes = this.getNodesByLabel(conceptMapData, nodeLabel);\n\n        // get the number of nodes with the given label\n        var nodeCount = nodes.length;\n\n        /*\n         * the comparison for the number which can be \"exactly\",\n         * \"more than\", or \"less than\"\n         */\n        var comparison = rule.comparison;\n\n        // the number to compare to\n        var number = rule.number;\n\n        if (comparison == 'exactly') {\n          /*\n           * we are looking for an exact number of nodes with the\n           * given label\n           */\n          if (nodeCount == number) {\n            result = true;\n          }\n        } else if (comparison == 'more than') {\n          /*\n           * we are looking for more than a certain number of nodes\n           * with the given label\n           */\n          if (nodeCount > number) {\n            result = true;\n          }\n        } else if (comparison == 'less than') {\n          /*\n           * we are looking for less than a certain number of nodes\n           * with the given label\n           */\n          if (nodeCount < number) {\n            result = true;\n          }\n        }\n\n        if (rule.not) {\n          /*\n           * the rule is satisfied if the result is false so we will\n           * negate the result\n           */\n          result = !result;\n        }\n\n      } else if (rule.type == 'link') {\n        // this is a link rule\n\n        // get the source node label\n        var nodeLabel = rule.nodeLabel;\n\n        // get the link label\n        var linkLabel = rule.linkLabel;\n\n        // get the destination node label\n        var otherNodeLabel = rule.otherNodeLabel;\n\n        // get all the links with the matching labels\n        var links = this.getLinksByLabels(conceptMapData, nodeLabel, linkLabel, otherNodeLabel);\n\n        // get the number of links with the matching labels\n        var linkCount = links.length;\n\n        /*\n         * the comparison for the number which can be \"exactly\",\n         * \"more than\", or \"less than\"\n         */\n        var comparison = rule.comparison;\n\n        // the number to compare to\n        var number = rule.number;\n\n        if (comparison == 'exactly') {\n          // we are looking for an exact number of links\n          if (linkCount == number) {\n            result = true;\n          }\n        } else if (comparison == 'more than') {\n          // we are looking for more than a certain number of links\n          if (linkCount > number) {\n            result = true;\n          }\n        } else if (comparison == 'less than') {\n          // we are looking for less than a certain number of links\n          if (linkCount < number) {\n            result = true;\n          }\n        }\n\n        if (rule.not) {\n          /*\n           * the rule is satisfied if the result is false so we will\n           * negate the result\n           */\n          result = !result;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Get a rule by the rule name\n   * @param componentContent the concept map component content\n   * @param ruleName the rule name\n   * @returns the rule with the given rule name\n   */\n  getRuleByRuleName(componentContent, ruleName) {\n\n    var rule = null;\n\n    if (ruleName != null) {\n\n      // get the rules\n      var rules = componentContent.rules;\n\n      if (rules != null) {\n\n        // loop through all the rules\n        for (var r = 0; r < rules.length; r++) {\n\n          // get a rule\n          var tempRule = rules[r];\n\n          if (tempRule != null) {\n\n            if (ruleName == tempRule.name) {\n              // we have found the rule with the name we want\n              rule = tempRule;\n            }\n          }\n        }\n      }\n    }\n\n    return rule;\n  }\n\n  /**\n   * Get the rules in the category\n   * @param componentContent the component content\n   * @param category the category name\n   * @returns the rules in the category\n   */\n  getRulesByCategoryName(componentContent, category) {\n\n    var rules = [];\n\n    if (componentContent != null) {\n\n      // get all the rules\n      var tempRules = componentContent.rules;\n\n      if (tempRules != null) {\n\n        // loop through all the rules\n        for (var r = 0; r < tempRules.length; r++) {\n          var rule = tempRules[r];\n\n          if (rule != null) {\n\n            // get the categories the rule is in\n            var categories = rule.categories;\n\n            if (categories != null) {\n\n              // loop through categories the rule is in\n              for (var c = 0; c < categories.length; c++) {\n                var tempCategory = categories[c];\n\n                if (category == tempCategory) {\n                  /*\n                   * the rule is in the category we are\n                   * searching for\n                   */\n                  rules.push(rule);\n                  break;\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n\n    return rules;\n  }\n\n  /**\n   * Get nodes by label\n   * @param conceptMapData the concept map student data\n   * @param label the node label to look for\n   * @returns all the nodes with the given label\n   */\n  getNodesByLabel(conceptMapData, label) {\n\n    var nodesByLabel = [];\n\n    if (conceptMapData != null) {\n\n      var nodes = conceptMapData.nodes;\n\n      if (nodes != null) {\n\n        // loop through all the nodes\n        for (var n = 0; n < nodes.length; n++) {\n          var node = nodes[n];\n\n          if (node != null) {\n\n            if (label == node.label || label == 'any') {\n              /*\n               * we have found a node with the label we are\n               * looking for\n               */\n              nodesByLabel.push(node);\n            }\n          }\n        }\n      }\n    }\n\n    return nodesByLabel;\n  }\n\n  /**\n   * Get links with the given source node label, link label, and destination\n   * node label\n   * @param conceptMapData the concept map student data\n   * @param nodeLabel the source node label\n   * @param linkLabel the link label\n   * @param otherNodeLabel the destination node label\n   * @returns the links with the given source node label, link label, and\n   * destination node label\n   */\n  getLinksByLabels(conceptMapData, nodeLabel, linkLabel, otherNodeLabel) {\n\n    var resultLinks = [];\n\n    if (conceptMapData != null) {\n\n      var links = conceptMapData.links;\n\n      if (links != null) {\n\n        // loop through all the links\n        for (var l = 0; l < links.length; l++) {\n          var tempLink = links[l];\n\n          if (tempLink != null) {\n\n            // get the labels\n            var tempLinkLabel = tempLink.label;\n            var sourceNodeLabel = tempLink.sourceNodeLabel;\n            var destinationNodeLabel = tempLink.destinationNodeLabel;\n\n            if ((nodeLabel == sourceNodeLabel || nodeLabel == 'any') &&\n              (linkLabel == tempLinkLabel || linkLabel == 'any') &&\n              (otherNodeLabel == destinationNodeLabel || otherNodeLabel == 'any')) {\n\n              // the labels match the ones we are looking for\n              resultLinks.push(tempLink);\n            }\n          }\n        }\n      }\n    }\n\n    return resultLinks;\n  }\n\n  /**\n   * Check if any of the rules are satisfied\n   * @param componentContent the concept map component content\n   * @param conceptMapData the concept map student data\n   * @param args an array of rule names\n   * @returns true if any of the rules are satisifed\n   * false if none of the rules are satisified\n   */\n  any(componentContent, conceptMapData, args) {\n\n    // loop through all the rule names\n    for (var n = 0; n < args.length; n++) {\n\n      // get a rule name\n      var ruleName = args[n];\n\n      // check if the rule is satisifed\n      var ruleResult = this.evaluateRuleByRuleName(componentContent, conceptMapData, ruleName);\n\n      if (ruleResult) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Check if all the rules are satisfied\n   * @param componentContent the concept map component content\n   * @param conceptMapData the concept map student data\n   * @param args an array of rule names\n   * @returns true if all the rules are satisifed\n   * false if any of the rules are not satisfied\n   */\n  all(componentContent, conceptMapData, args) {\n    var result = true;\n\n    // loop through all the rule names\n    for (var n = 0; n < args.length; n++) {\n\n      // get a rule name\n      var ruleName = args[n];\n\n      // check if the rule is satisfied\n      var ruleResult = this.evaluateRuleByRuleName(componentContent, conceptMapData, ruleName);\n\n      result = result && ruleResult;\n    }\n    return result;\n  }\n\n  /**\n   * Populate the concept map data into the component\n   * @param draw the SVG draw div\n   * @param conceptMapData the concept map data which contains an array\n   * of nodes and an array of links\n   */\n  populateConceptMapData(draw, conceptMapData) {\n    if (conceptMapData != null) {\n\n      // get the JSON nodes\n      var nodes = conceptMapData.nodes;\n\n      // this is used to hold the SVG node objects\n      var conceptMapNodes = [];\n\n      if (nodes != null) {\n\n        // loop through all the nodes\n        for (var n = 0; n < nodes.length; n++) {\n          var node = nodes[n];\n\n          var instanceId = node.instanceId;\n          var originalId = node.originalId;\n          var filePath = node.fileName;\n          var label = node.label;\n          var x = node.x;\n          var y = node.y;\n          var width = node.width;\n          var height = node.height;\n          var showLabel = true;\n\n          // create a ConceptMapNode\n          var conceptMapNode = this.newConceptMapNode(\n              draw, instanceId, originalId, filePath, label, x, y, width, height, showLabel);\n\n          conceptMapNodes.push(conceptMapNode);\n        }\n      }\n\n      // get the JSON links\n      var links = conceptMapData.links;\n\n      // this is used to hold the SVG link objects\n      var conceptMapLinks = [];\n\n      if (links != null) {\n\n        // loop through all the links\n        for (var l = 0; l < links.length; l++) {\n          var link = links[l];\n\n          var instanceId = link.instanceId;\n          var originalId = link.originalId;\n          var sourceNodeId = link.sourceNodeInstanceId;\n          var destinationNodeId = link.destinationNodeInstanceId;\n          var label = link.label;\n          var color = link.color;\n          var curvature = link.curvature;\n          var startCurveUp = link.startCurveUp;\n          var endCurveUp = link.endCurveUp;\n          var sourceNode = null;\n          var destinationNode = null;\n\n          if (sourceNodeId != null) {\n            sourceNode = this.getNodeById(conceptMapNodes, sourceNodeId);\n          }\n\n          if (destinationNodeId != null) {\n            destinationNode = this.getNodeById(conceptMapNodes, destinationNodeId);\n          }\n\n          // create a ConceptMapLink\n          var conceptMapLink = this.newConceptMapLink(draw, instanceId, originalId, sourceNode, destinationNode, label, color, curvature, startCurveUp, endCurveUp);\n\n          conceptMapLinks.push(conceptMapLink);\n        }\n      }\n\n      /*\n       * move the link text group to the front so that they are on top\n       * of links\n       */\n      this.moveLinkTextToFront(conceptMapLinks);\n\n      // move the nodes to the front so that they are on top of links\n      this.moveNodesToFront(conceptMapNodes);\n\n      /*\n       * set a timeout to refresh the link labels so that the rectangles\n       * around the labels are properly resized\n       */\n      // this.$timeout(() => {\n      //   this.refreshLinkLabels(conceptMapNodes, conceptMapLinks);\n      // });\n      this.refreshLinkLabels(conceptMapNodes, conceptMapLinks);\n    }\n  }\n\n  /**\n   * Move the link text group to the front\n   */\n  moveLinkTextToFront(links) {\n\n    // loop through all the links\n    for (var l = 0; l < links.length; l++) {\n      var link = links[l];\n\n      if (link != null) {\n        // move the link text group to the front\n        link.moveTextGroupToFront();\n      }\n    }\n  }\n\n  /**\n   * Move the nodes to the front so that they show up above links\n   */\n  moveNodesToFront(nodes) {\n\n    // loop through all the nodes\n    for (var n = 0; n < nodes.length; n++) {\n      var node = nodes[n];\n\n      if (node != null) {\n\n        // get a node group\n        var group = node.getGroup();\n\n        if (group != null) {\n          // move the node group to the front\n          group.front();\n        }\n      }\n    }\n  }\n\n  /**\n   * Refresh the link labels so that the rectangles around the text\n   * labels are resized to fit the text properly. This is required because\n   * the rectangles are not properly sized when the ConceptMapLinks are\n   * initialized. The rectangles need to be rendered first and then the\n   * labels need to be set in order for the rectangles to be resized properly.\n   * This is why this function is called in a $timeout.\n   */\n  refreshLinkLabels(nodes, links) {\n\n    if (nodes != null) {\n\n      // loop through all the nodes\n      for (var n = 0; n < nodes.length; n++) {\n        var node = nodes[n];\n\n        if (node != null) {\n          // get the label from the node\n          var label = node.getLabel();\n\n          /*\n           * set the label back into the node so that the rectangle\n           * around the text label is resized to the text\n           */\n          node.setLabel(label);\n        }\n      }\n    }\n\n    if (links != null) {\n\n      // loop throgh all the links\n      for (var l = 0; l < links.length; l++) {\n        var link = links[l];\n\n        if (link != null) {\n          // get the label from the link\n          var label = link.getLabel();\n\n          /*\n           * set the label back into the link so that the rectangle\n           * around the text label is resized to the text\n           */\n          link.setLabel(label);\n        }\n      }\n    }\n  }\n\n  /**\n   * Get a node by id.\n   * @param id the node id\n   * @returns the node with the given id or null\n   */\n  getNodeById(nodes, id) {\n    var node = null;\n\n    if (id != null) {\n\n      // loop through all the nodes\n      for (var n = 0; n < nodes.length; n++) {\n        var tempNode = nodes[n];\n        var tempNodeId = tempNode.getId();\n\n        if (id == tempNodeId) {\n          // we have found the node we want\n          node = tempNode;\n          break;\n        }\n      }\n    }\n\n    return node;\n  }\n\n  /**\n   * Create an image from the concept map data\n   * @param conceptMapData concept map data from a student\n   * @param width the width of the image we want to create\n   * @param height the height of the image we want to create\n   */\n  createImage(conceptMapData, width, height) {\n\n    // create a promise that will return an image of the concept map\n    var deferred = this.$q.defer();\n\n    // create a div to draw the SVG in\n    var svgElement = document.createElement('div');\n\n    if (width == null || width == '') {\n      // we will default to a width of 800 pixels\n      width = 800;\n    }\n\n    if (height == null || height == '') {\n      // we will default to a height of 600 pixels\n      height = 600;\n    }\n\n    var draw = SVG(svgElement);\n    draw.width(width);\n    draw.height(height);\n\n    if (svgElement != null) {\n\n      // populate the concept map data into the svg draw element\n      this.populateConceptMapData(draw, conceptMapData);\n\n      // get the svg element as a string\n      var svgString = svgElement.innerHTML;\n\n      // find all the images in the svg and replace them with Base64 images\n      this.getHrefToBase64ImageReplacements(svgString, true).then((images) => {\n\n        /*\n         * Loop through all the image objects. Each object contains\n         * an image href and a Base64 image.\n         */\n        for (var i = 0; i < images.length; i++) {\n\n          // get an image object\n          var imagePair = images[i];\n\n          // get the image href e.g. /wise/curriculum/25/assets/Sun.png\n          var imageHref = imagePair.imageHref;\n\n          // get the last index of '/'\n          var lastIndexOfSlash = imageHref.lastIndexOf('/');\n\n          if (lastIndexOfSlash != -1) {\n            // only get everything after the last '/'\n            imageHref = imageHref.substring(lastIndexOfSlash + 1);\n          }\n\n          // get the Base64 image\n          var base64Image = imagePair.base64Image;\n\n          // create a regex to match the image href\n          var imageRegEx = new RegExp(imageHref, 'g');\n\n          /*\n           * replace all the instances of the image href with the\n           * Base64 image\n           */\n          svgString = svgString.replace(imageRegEx, base64Image);\n        }\n\n        // create a canvas to draw the image on\n        var myCanvas = document.createElement('canvas');\n        var ctx = myCanvas.getContext('2d');\n\n        // create an svg blob\n        var svg = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});\n        var domURL = self.URL || self.webkitURL || self;\n        var url = domURL.createObjectURL(svg);\n        var image = new Image;\n\n        /*\n         * set the UtilService in a local variable so we can access it\n         * in the onload callback function\n         */\n        var thisUtilService = this.UtilService;\n\n        // the function that is called after the image is fully loaded\n        image.onload = (event) => {\n\n          // get the image that was loaded\n          var image = event.target;\n\n          // set the dimensions of the canvas\n          myCanvas.width = image.width;\n          myCanvas.height = image.height;\n          ctx.drawImage(image, 0, 0);\n\n          // get the canvas as a Base64 string\n          var base64Image = myCanvas.toDataURL('image/png');\n\n          // get the image object\n          var imageObject = thisUtilService.getImageObjectFromBase64String(base64Image);\n\n          // create a student asset image\n          this.StudentAssetService.uploadAsset(imageObject).then((unreferencedAsset) => {\n\n            /*\n             * make a copy of the unreferenced asset so that we\n             * get a referenced asset\n             */\n            this.StudentAssetService.copyAssetForReference(unreferencedAsset).then((referencedAsset) => {\n              if (referencedAsset != null) {\n                /*\n                 * get the asset url\n                 * for example\n                 * /wise/studentuploads/11261/297478/referenced/picture_1494016652542.png\n                 */\n                var referencedAssetUrl = referencedAsset.url;\n\n                // remove the unreferenced asset\n                this.StudentAssetService.deleteAsset(unreferencedAsset);\n\n                // resolve the promise with the image url\n                deferred.resolve(referencedAssetUrl);\n              }\n            });\n          });\n        };\n\n        // set the src of the image so that the image gets loaded\n        image.src = url;\n      });\n    }\n\n    return deferred.promise;\n  }\n\n  /**\n   * Get Base64 images from image hrefs\n   * @param svgString the svg string\n   * @param prependAssetsPath whether to prepend the assets directory path\n   * to the image references\n   * @return a promise that will return an array of objects. The objects will\n   * contain an image href and a Base64 image.\n   */\n  getHrefToBase64ImageReplacements(svgString, prependAssetsPath) {\n\n    // an array to hold all the promises\n    var promises = [];\n\n    // get all the image hrefs\n    var imageHrefs = this.getImagesInSVG(svgString);\n\n    // loop through all the images\n    for (var i = 0; i < imageHrefs.length; i++) {\n\n      // get an image href\n      var imageHref = imageHrefs[i];\n\n      if (prependAssetsPath) {\n        /*\n         * the image href is relative so we need to make it absolute\n         * so that the browser can retrieve it\n         */\n\n        // prepend the project asset directory path\n        imageHref = this.ConfigService.getProjectAssetsDirectoryPath(true) + '/' + imageHref;\n      }\n\n      // get the Base64 of the image\n      var promise = this.getBase64Image(imageHref);\n\n      promises.push(promise);\n    }\n\n    return this.$q.all(promises);\n  }\n\n  /**\n   * Get all the image hrefs in the svg string\n   * @param svgString the svg string\n   * @return an array of image hrefs\n   */\n  getImagesInSVG(svgString) {\n\n    // used to hold all the images we find\n    var images = [];\n\n    if (svgString != null) {\n\n      /*\n       * the regex to match href values in image elements\n       * e.g.\n       * if the svg contained in image element like this\n       * <image id=\"SvgjsImage1007\" xlink:href=\"/wise/curriculum/25/assets/Sun.png\" width=\"100\" height=\"100\"/>\n       * it would match it and the matching group would contain\n       * /wise/curriculum/25/assets/Sun.png\n       */\n      var regex = /<image.*?xlink:href=\"(.*?)\".*?\\/?>/g;\n\n      // find the first match in the svg string\n      var result = regex.exec(svgString);\n\n      while(result != null) {\n\n        /*\n         * get the href image from the match\n         * e.g.\n         * /wise/curriculum/25/assets/Sun.png\n         */\n        var imageHref = result[1];\n\n        // add the href to our array of hrefs\n        images.push(imageHref);\n\n        // try to find the next match\n        result = regex.exec(svgString);\n      }\n    }\n\n    return images;\n  }\n\n  /**\n   * Get the Base64 image from an image href. An image href will look like\n   * /wise/curriculum/25/assets/Sun.png\n   * @param imageHref the image href\n   * @return a promise that will return an object containing the image href\n   * and the Base64 image\n   */\n  getBase64Image(imageHref) {\n\n    var deferred = this.$q.defer();\n\n    // create the image object that we will load the image into\n    var image = new Image;\n\n    // create a new canvas to render the image in\n    var myCanvas = document.createElement('canvas');\n    var ctx = myCanvas.getContext('2d');\n\n    // the function that is called after the image is fully loaded\n    image.onload = function(event) {\n\n      // get the image that was loaded\n      var image = event.target;\n\n      // set the canvas dimensions to match the image\n      myCanvas.width = image.width;\n      myCanvas.height = image.height;\n\n      // draw the image in the canvas\n      ctx.drawImage(image, 0, 0);\n\n      // get the Base64 string of the canvas\n      var base64Image = myCanvas.toDataURL('image/png');\n\n      // create an object that will contain the image href and Base64 image\n      var result = {};\n      result.imageHref = imageHref;\n      result.base64Image = base64Image;\n\n      // resolve the promise with the object\n      deferred.resolve(result);\n    }\n\n    // load the image\n    image.src = imageHref;\n\n    // return the promise\n    return deferred.promise;\n  }\n\n  /**\n   * Check if the component state has student work. Sometimes a component\n   * state may be created if the student visits a component but doesn't\n   * actually perform any work. This is where we will check if the student\n   * actually performed any work.\n   * @param componentState the component state object\n   * @param componentContent the component content\n   * @return whether the component state has any work\n   */\n  componentStateHasStudentWork(componentState, componentContent) {\n\n    if (componentState != null) {\n\n      let studentData = componentState.studentData;\n\n      if (studentData != null) {\n\n        let nodes = [];\n        let links = [];\n        let conceptMapData = studentData.conceptMapData;\n\n        if (conceptMapData != null) {\n          if (conceptMapData.nodes != null) {\n            nodes = conceptMapData.nodes;\n          }\n\n          if (conceptMapData.links != null) {\n            links = conceptMapData.links;\n          }\n        }\n\n        if (componentContent == null) {\n          // the component content was not provided\n\n          if (nodes.length > 0) {\n            // the student has created a node\n            return true;\n          }\n\n          if (links.length > 0) {\n            // the student has created a link\n            return true;\n          }\n        } else {\n          // the component content was provided\n\n          let starterConceptMap = componentContent.starterConceptMap;\n\n          if (starterConceptMap == null || starterConceptMap === '') {\n            // there is no starter concept map\n\n            if (nodes.length > 0) {\n              // the student has created a node\n              return true;\n            }\n\n            if (links.length > 0) {\n              // the student has created a link\n              return true;\n            }\n          } else {\n            /*\n             * there is a starter concept map so we will compare it\n             * with the student concept map\n             */\n            if (this.isStudentConceptMapDifferentThanStarterConceptMap(conceptMapData, starterConceptMap)) {\n              return true;\n            }\n          }\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Check if the student concept map is different than the starter conept map\n   * @param studentConceptMap the student concept map\n   * @param starterConceptMap the authored starter concept map\n   * @return whether the student concept map is different than the starter\n   * concept map\n   */\n  isStudentConceptMapDifferentThanStarterConceptMap(studentConceptMap, starterConceptMap) {\n\n    if (studentConceptMap != null && starterConceptMap != null) {\n\n      let studentNodes = studentConceptMap.nodes;\n      let studentLinks = studentConceptMap.links;\n\n      let starterNodes = starterConceptMap.nodes;\n      let starterLinks = starterConceptMap.links;\n\n      if (studentNodes.length == starterNodes.length) {\n        /*\n         * the student has the same number of nodes as the starter so\n         * we will need to check if the nodes area actually different\n         */\n\n        // loop through all the nodes\n        for (let n = 0; n < studentNodes.length; n++) {\n          let studentNode = studentNodes[n];\n          let starterNode = starterNodes[n];\n\n          if (studentNode != null && starterNode != null) {\n\n            // check if any of the fields have different values\n            if (studentNode.originalId != starterNode.originalId ||\n              studentNode.instanceId != starterNode.instanceId ||\n              studentNode.x != starterNode.x ||\n              studentNode.y != starterNode.y) {\n\n              // the student node is different than the starter node\n              return true;\n            }\n          }\n        }\n      } else {\n        // the student has a different number of nodes\n        return true;\n      }\n\n      if (studentLinks.length == starterLinks.length) {\n        /*\n         * the student has the same number of links as the starter so\n         * we will need to check if the links area actually different\n         */\n\n        // loop through all the links\n        for (let l = 0; l < studentLinks.length; l++) {\n          let studentLink = studentLinks[l];\n          let starterLink = starterLinks[l];\n\n          if (studentLink != null && starterLink != null) {\n\n            // check if any of the fields have different values\n            if (studentLink.label != starterLink.label ||\n              studentLink.originalId != starterLink.originalId ||\n              studentLink.instanceId != starterLink.instanceId ||\n              studentLink.sourceNodeOriginalId != starterLink.sourceNodeOriginalId ||\n              studentLink.sourceNodeInstanceId != starterLink.sourceNodeInstanceId ||\n              studentLink.destinationNodeOriginalId != starterLink.destinationNodeOriginalId ||\n              studentLink.destinationNodeInstanceId != starterLink.destinationNodeInstanceId) {\n\n              // the student link is different than the starter link\n              return true;\n            }\n          }\n        }\n      } else {\n        // the student has a different number of links\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * The component state has been rendered in a <component></component> element\n   * and now we want to take a snapshot of the work.\n   * @param componentState The component state that has been rendered.\n   * @return A promise that will return an image object.\n   */\n  generateImageFromRenderedComponentState(componentState) {\n    let deferred = this.$q.defer();\n\n    // get the svg element. this will obtain an array.\n    let svgElement = angular.element('#svg_' + componentState.nodeId + '_' + componentState.componentId);\n\n    if (svgElement != null && svgElement.length > 0) {\n      // get the svg element\n      svgElement = svgElement[0];\n\n      // get the svg element as a string\n      let serializer = new XMLSerializer();\n      let svgString = serializer.serializeToString(svgElement);\n\n      // find all the images in the svg and replace them with Base64 images\n      this.getHrefToBase64ImageReplacements(svgString).then((images) => {\n\n        /*\n         * Loop through all the image objects. Each object contains\n         * an image href and a Base64 image.\n         */\n        for (let i = 0; i < images.length; i++) {\n\n          // get an image object\n          let imagePair = images[i];\n\n          // get the image href e.g. /wise/curriculum/25/assets/Sun.png\n          let imageHref = imagePair.imageHref;\n\n          // get the Base64 image\n          let base64Image = imagePair.base64Image;\n\n          // create a regex to match the image href\n          let imageRegEx = new RegExp(imageHref, 'g');\n\n          /*\n           * replace all the instances of the image href with the\n           * Base64 image\n           */\n          svgString = svgString.replace(imageRegEx, base64Image);\n        }\n\n        // create a canvas to draw the image on\n        let myCanvas = document.createElement('canvas');\n        let ctx = myCanvas.getContext('2d');\n\n        // create an svg blob\n        let svg = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});\n        let domURL = self.URL || self.webkitURL || self;\n        let url = domURL.createObjectURL(svg);\n        let image = new Image();\n\n        // the function that is called after the image is fully loaded\n        image.onload = (event) => {\n\n          // get the image that was loaded\n          let image = event.target;\n\n          // set the dimensions of the canvas\n          myCanvas.width = image.width;\n          myCanvas.height = image.height;\n          ctx.drawImage(image, 0, 0);\n\n          // get the canvas as a Base64 string\n          let base64Image = myCanvas.toDataURL('image/png');\n\n          // get the image object\n          let imageObject = this.UtilService.getImageObjectFromBase64String(base64Image, false);\n\n          // add the image to the student assets\n          this.StudentAssetService.uploadAsset(imageObject).then((asset) => {\n            deferred.resolve(asset);\n          });\n        };\n\n        // set the src of the image so that the image gets loaded\n        image.src = url;\n      });\n    }\n    return deferred.promise;\n  }\n\n  /**\n   *\n   * @param objects An array of nodes or links.\n   * @param prefix The prefix for the given type of objects\n   * For example the prefix for 'studentNode3' would be\n   * 'studentNode'\n   */\n  getNextAvailableId(objects, prefix) {\n    let nextAvailableNumber = 1;\n    const usedNumbers = [];\n    for (let object of objects) {\n      const objectId = object.id;\n      const objectIdNumber = parseInt(objectId.replace(prefix, ''));\n      usedNumbers.push(objectIdNumber);\n    }\n\n    if (usedNumbers.length > 0) {\n      const maxNumberUsed = Math.max.apply(Math, usedNumbers);\n      if (!isNaN(maxNumberUsed)) {\n        nextAvailableNumber = maxNumberUsed + 1;\n      }\n    }\n\n    return prefix + nextAvailableNumber;\n  }\n\n  // end of ConceptMapService class\n}\n\n\n/**\n * A ConceptMapNode that represents a node in the ConceptMap component\n */\nclass ConceptMapNode {\n\n  /**\n   * The constructor for creating ConceptMapNodes\n   * @param ConceptMapService the ConceptMapService\n   * @param draw the svg.js draw object\n   * @param filePath the path of the image file that represents the node\n   * @param label the label of the node\n   * @param x the x position of the node\n   * @param y the y position of the node\n   * @param width the the width of the node\n   * @param height the height of the node\n   * @param showLabel whether to show the label\n   */\n  constructor(ConceptMapService, draw, id, originalId, filePath, label, x, y, width, height, showLabel) {\n\n    // remember the ConceptMapService\n    this.ConceptMapService = ConceptMapService;\n\n    // remember the svg.js draw object so we can draw onto it\n    this.draw = draw;\n\n    // set the id\n    this.id = id;\n\n    // set the original id\n    this.originalId = originalId;\n\n    // remember the file path e.g. \"/wise/curriculum/108/assets/Space.png\"\n    this.filePath = filePath;\n\n    if (this.filePath != null) {\n      // get the file name e.g. \"Space.png\"\n      this.fileName = this.filePath.substring(this.filePath.lastIndexOf('/') + 1);\n    }\n\n    // remember the label\n    this.label = label;\n    this.showLabel = showLabel;\n\n    // create the svg image object\n    this.image = this.draw.image(this.filePath, width, height);\n\n    // remember the width\n    this.width = width;\n\n    // remember the height\n    this.height = height;\n\n    // create a group to contain all the elements of this node\n    this.group = this.draw.group();\n\n    // flag that specifies whether this node is highlighted by the student\n    this.highlighted = false;\n\n    // the color of the delete button\n    this.deleteButtonColor = 'gray';\n\n    // create the connector that students will use to create links\n    this.connector = this.createConnector();\n\n    // create the delete button\n    this.deleteButtonGroup = this.createDeleteButtonGroup();\n\n    /*\n     * create the border that displays when the node is highighted or\n     * moused over\n     */\n    this.border = this.createBorder();\n\n    // remember the x and y coordinates\n    this.x = x;\n    this.y = y;\n\n    // initialize the outgoing and incoming links arrays\n    this.outgoingLinks = [];\n    this.incomingLinks = [];\n\n    // add all the elements to the group\n    this.group.add(this.border);\n    this.group.add(this.image);\n    this.group.add(this.connector);\n    this.group.add(this.deleteButtonGroup);\n    if (showLabel) {\n      this.textGroup = this.createTextGroup();\n      this.group.add(this.textGroup);\n    }\n\n    // hide the border and delete button\n    this.border.hide();\n    this.deleteButtonGroup.hide();\n\n    // set the position of the group\n    this.group.x(x);\n    this.group.y(y);\n  }\n\n  /**\n   * Get the JSON object representation of the ConceptMapNode\n   * @returns a JSON object containing the data of the ConceptMapNode\n   */\n  toJSONObject() {\n    var jsonObject = {};\n\n    jsonObject.originalId = this.originalId;\n    jsonObject.instanceId = this.id;\n    jsonObject.fileName = this.fileName;\n    jsonObject.filePath = this.filePath;\n    jsonObject.label = this.label;\n    jsonObject.x = this.x;\n    jsonObject.y = this.y;\n    jsonObject.width = this.width;\n    jsonObject.height = this.height;\n\n    jsonObject.outgoingLinks = [];\n    jsonObject.incomingLinks = [];\n\n    // loop through all the outgoing links\n    for (var ol = 0; ol < this.outgoingLinks.length; ol++) {\n      var outgoingLink = this.outgoingLinks[ol];\n\n      var instanceId = outgoingLink.getId();\n      var originalId = outgoingLink.getOriginalId();\n      var label = outgoingLink.getLabel();\n\n      /*\n       * create an object containing the instance id, original id\n       * and label of the link\n       */\n      var tempLinkObject = {};\n      tempLinkObject.originalId = originalId;\n      tempLinkObject.instanceId = instanceId;\n      tempLinkObject.label = label;\n\n      jsonObject.outgoingLinks.push(tempLinkObject);\n    }\n\n    // loop through all the incoming links\n    for (var il = 0; il < this.incomingLinks.length; il++) {\n      var incomingLink = this.incomingLinks[il];\n\n      var instanceId = incomingLink.getId();\n      var originalId = incomingLink.getOriginalId();\n      var label = incomingLink.getLabel();\n\n      /*\n       * create an object containing the instance id, original id\n       * and label of the link\n       */\n      var tempLinkObject = {};\n      tempLinkObject.originalId = originalId;\n      tempLinkObject.instanceId = instanceId;\n      tempLinkObject.label = label;\n\n      jsonObject.incomingLinks.push(tempLinkObject);\n    }\n\n    return jsonObject;\n  }\n\n  /**\n   * Create the border that displays when the node is highlighted or\n   * moused over.\n   * @returns the svg rectangle that represents the border\n   */\n  createBorder() {\n\n    // create the rectangle\n    this.border = this.draw.rect(this.width, this.height);\n    this.border.fill('none');\n    this.border.stroke({ color: '#333333', opacity: 0.2, width: 2 });\n\n    return this.border;\n  }\n\n  /**\n   * Create the connector that students will use to create links from this\n   * node.\n   * @returns the svg circle that represents the connector\n   */\n  createConnector() {\n\n    // create the circle\n    var connectorRadius = 10;\n    this.connector = this.draw.circle();\n    this.connector.radius(connectorRadius);\n    this.connector.cx(this.width / 2);\n    this.connector.cy(0);\n    this.connector.fill({ color: '#cccccc', opacity: 0.4 });\n    this.connector.stroke({ color: '#333333', opacity: 0.2 });\n\n    return this.connector;\n  }\n\n  /**\n   * Create the delete button. The delete button is a group that contains\n   * a circle and an x.\n   * @returns a group that contains a circle and an x\n   */\n  createDeleteButtonGroup() {\n\n    // create a group to contain the circle and x for the delete button\n    this.deleteButtonGroup = this.draw.group();\n\n    // create the delete button circle\n    var deleteButtonRadius = 10;\n    this.deleteButtonCircle = this.draw.circle();\n    this.deleteButtonCircle.radius(deleteButtonRadius);\n    this.deleteButtonCircle.cx(this.width);\n    this.deleteButtonCircle.cy(0);\n    this.deleteButtonCircle.fill({ opacity: 0.0 });\n    this.deleteButtonCircle.stroke({ color: '#333333', opacity: 0.2, width: 2 });\n\n    // create the x by first creating a + and then rotating it 45 degrees\n\n    // get the top location of the +\n    var topX = 0;\n    var topY = 0 - (deleteButtonRadius * 0.7);\n\n    // get the bottom location of the +\n    var bottomX = 0;\n    var bottomY = 0 + (deleteButtonRadius * 0.7);\n\n    // get the left position of the +\n    var leftX = 0 - (deleteButtonRadius * 0.7);\n    var leftY = 0;\n\n    // get the right position of the +\n    var rightX = 0 + (deleteButtonRadius * 0.7);\n    var rightY = 0;\n\n    // draw the +\n    var deleteButtonXPath = 'M' + topX + ',' + topY + 'L' + bottomX + ',' + bottomY + 'M' + leftX + ',' + leftY + 'L' + rightX + ',' + rightY;\n    this.deleteButtonX = this.draw.path(deleteButtonXPath);\n    this.deleteButtonX.stroke({ color: '#333333', opacity: 0.2, width: 2 });\n\n    // rotate the + to turn it into an x\n    this.deleteButtonX.transform({ rotation: 45 });\n\n    // move the x to the upper right of the group\n    this.deleteButtonX.translate(this.width, 0);\n\n    /*\n     * disable pointer events on the x so that clicks will pass through\n     * and hit the circle. this way we only need to set a listener on the\n     * circle for click events.\n     */\n    this.deleteButtonX.attr('pointer-events', 'none');\n\n    // add the circle and the x\n    this.deleteButtonGroup.add(this.deleteButtonCircle);\n    this.deleteButtonGroup.add(this.deleteButtonX);\n\n    return this.deleteButtonGroup;\n  }\n\n  /**\n   * Create the text group\n   * @returns the text group\n   */\n  createTextGroup() {\n\n    // create the group\n    this.textGroup = this.draw.group();\n\n    // create a rectangle to surround the text\n    this.textRect = this.draw.rect(100, 15);\n    this.textRect.attr('fill', 'white');\n    this.textRect.attr('stroke', 'black');\n    this.textRect.attr('x', 0);\n    this.textRect.attr('y', 10);\n    this.textRect.attr('width', 100);\n    this.textRect.attr('height', 20);\n    this.textRect.radius(5);\n\n    // create the text element\n    this.text = this.draw.text(this.label);\n    this.text.attr('x', 5);\n    //this.text.attr('x', 0);\n    this.text.attr('y', 9);\n    this.text.font({\n      family: 'Arial',\n      size: 12\n    });\n\n    // prevent the text from being highlighted when the user drags the mouse\n    this.text.style('user-select:none');\n    this.text.node.setAttribute('user-select', 'none');\n    this.text.node.setAttribute('style', 'user-select:none');\n\n    // add the rectangle and text to the group\n    this.textGroup.add(this.textRect);\n    this.textGroup.add(this.text);\n\n    // add the text group to the link group\n    this.group.add(this.textGroup);\n\n    var width = 0;\n\n    try {\n      // get the width of the bounding box of the text node\n      var textBBox = this.text.node.getBBox();\n\n      if (textBBox.width == 0) {\n        width = this.calculateTextRectWidth(this.label);\n      } else {\n        width = textBBox.width + 10;\n      }\n    } catch(e) {\n      /*\n       * we were unable to get the bounding box (likely because\n       * Firefox threw an error when trying to call getBBox())\n       * so we will calculate the width based on the label text\n       */\n      width = this.calculateTextRectWidth(this.label);\n    }\n\n    this.textRect.attr('width', width);\n\n    // set the position of the text group\n    var x = this.getImageWidth() / 2;\n    var y = this.getImageHeight();\n    this.textGroup.cx(x);\n    this.textGroup.cy(y);\n\n    return this.textGroup;\n  }\n\n  /**\n   * Get the id of the node\n   * @returns the id of the node\n   */\n  getId() {\n    return this.id;\n  }\n\n  /**\n   * Get the original id of the node\n   * @returns the original id of the node\n   */\n  getOriginalId() {\n    return this.originalId;\n  }\n\n  /**\n   * Get the group id of the node\n   * @returns the group id of the node\n   */\n  getGroupId() {\n    var groupId = null;\n\n    if (this.group != null) {\n      // get the id of the group which we will use as the id of the node\n      groupId = this.group.id();\n    }\n\n    return groupId;\n  }\n\n  /**\n   * Get the label\n   * @returns the label of the node\n   */\n  getLabel() {\n    return this.label;\n  }\n\n  /**\n   * Set the label of the node\n   * @param label the label of the node\n   */\n  setLabel(label) {\n\n    // remember the label\n    this.label = label;\n\n    // set the label into the text element\n    this.text.text(label);\n\n    var width = 0;\n\n    try {\n      // get the width of the bounding box of the text node\n      var textBBox = this.text.node.getBBox();\n\n      if (textBBox.width == 0) {\n        width = this.calculateTextRectWidth(this.label);\n      } else {\n        width = textBBox.width + 10;\n      }\n    } catch(e) {\n      /*\n       * we were unable to get the bounding box (likely because\n       * Firefox threw an error when trying to call getBBox())\n       * so we will calculate the width based on the label text\n       */\n      width = this.calculateTextRectWidth(this.label);\n    }\n\n    this.textRect.attr('width', width);\n\n    // set the position of the text group\n    var x = this.getImageWidth() / 2;\n    var y = this.getImageHeight();\n    this.textGroup.cx(x);\n    this.textGroup.cy(y);\n  }\n\n  /**\n   * Get the center x coordinate of the group\n   */\n  cx() {\n    var val = 0;\n\n    if (this.group != null && this.image != null) {\n\n      // get the group\n      var groupX = this.group.x();\n\n      /*\n       * get the center x coordinate of the image relative to the group.\n       * this will be equal to half the width of the image.\n       */\n      var imageCX = this.image.cx();\n\n      /*\n       * get the x coordinate of the center of the group relative to the\n       * svg parent\n       */\n      val = groupX + imageCX;\n    }\n\n    return val;\n  }\n\n  /**\n   * Get the center y coordinate of the group\n   */\n  cy() {\n    var val = 0;\n\n    if (this.group != null && this.image != null) {\n\n      // get the group\n      var groupY = this.group.y();\n\n      /*\n       * get the center y coordinate of the image relative to the group.\n       * this will be equal to half the height of the image.\n       */\n      var imageCY = this.image.cy();\n\n      /*\n       * get the y coordinate of the center of the group relative to the\n       * svg parent\n       */\n      val = groupY + imageCY;\n    }\n\n    return val;\n  }\n\n  /**\n   * Get the center x coordinate of the group\n   */\n  connectorCX() {\n    var val = 0;\n\n    if (this.group != null && this.image != null) {\n\n      // get the group\n      var groupX = this.group.x();\n\n      /*\n       * get the center x coordinate of the image relative to the group.\n       * this will be equal to half the width of the image.\n       */\n      var imageCX = this.connector.cx();\n\n      /*\n       * get the x coordinate of the center of the group relative to the\n       * svg parent\n       */\n      val = groupX + imageCX;\n    }\n\n    return val;\n  }\n\n  /**\n   * Get the center y coordinate of the group\n   */\n  connectorCY() {\n    var val = 0;\n\n    if (this.group != null && this.image != null) {\n\n      // get the group\n      var groupY = this.group.y();\n\n      /*\n       * get the center y coordinate of the image relative to the group.\n       * this will be equal to half the height of the image.\n       */\n      var imageCY = this.connector.cy();\n\n      /*\n       * get the y coordinate of the center of the group relative to the\n       * svg parent\n       */\n      val = groupY + imageCY;\n    }\n\n    return val;\n  }\n\n  /**\n   * Getter/setter for whether the node is highlighted\n   * @parm value (optional) boolean value that sets the highlighted value\n   * @returns whether the node is highlighted\n   */\n  isHighlighted(value) {\n\n    if (value != null) {\n      this.highlighted = value;\n    }\n\n    return this.highlighted;\n  }\n\n  /**\n   * Get the group\n   * @returns the group\n   */\n  getGroup() {\n    return this.group;\n  }\n\n  /**\n   * Show the delete button group\n   */\n  showDeleteButton() {\n    this.deleteButtonGroup.show();\n  }\n\n  /**\n   * Hide the delete button group\n   */\n  hideDeleteButton() {\n    this.deleteButtonGroup.hide();\n  }\n\n  /**\n   * Show the border of the node\n   */\n  showBorder() {\n    this.border.show();\n  }\n\n  /**\n   * Hide the border of the node\n   */\n  hideBorder() {\n    this.border.hide();\n  }\n\n  /**\n   * Get the connector of the node\n   */\n  getConnector() {\n    return this.connector;\n  }\n\n  /**\n   * Get the id of the connector\n   */\n  getConnectorId() {\n    var id = null;\n\n    if (this.connector != null) {\n      id = this.connector.id();\n    }\n\n    return id;\n  }\n\n  /**\n   * Get the x position of the group within the svg\n   * @returns the x position of the group\n   */\n  getGroupX() {\n\n    var x = 0;\n\n    if (this.group != null) {\n      /*\n       * the image is located at 0, 0 within the group so we will obtain\n       * the x location of the group\n       */\n      x = this.group.x();\n    }\n\n    return x;\n  }\n\n  /**\n   * Get the y position of the group within the svg\n   * @returns the y position of the group\n   */\n  getGroupY() {\n    var y = 0;\n\n    if (this.group != null) {\n      /*\n       * the image is located at 0, 0 within the group so we will obtain\n       * the y location of the group\n       */\n      y = this.group.y();\n    }\n\n    return y;\n  }\n\n  /**\n   * Get the x position of the image within the svg\n   * @returns the x position of the image\n   */\n  getImageX() {\n\n    // get the x position of the group\n    var groupX = this.getGroupX();\n\n    // get the x position of the image relative to the group\n    var imageRelativeX = this.image.x();\n\n    // add the values together to get the absolute x position of the image\n    var imageX = groupX + imageRelativeX;\n\n    // get the group\n    var group = this.getGroup();\n\n    // check if the group is shifted\n    if (group != null) {\n      // get the bounding box of the group\n      var bbox = group.bbox();\n\n      if (bbox != null) {\n        // get the x position of the bounding box on the group\n        var bboxX = bbox.x;\n\n        // compensate for the shift of the group\n        imageX = imageX - bboxX;\n      }\n    }\n\n    return imageX;\n  }\n\n  /**\n   * Get the y position of the image within the svg\n   * @returns the y position of the image\n   */\n  getImageY() {\n\n    // get the y position of the group\n    var groupY = this.getGroupY();\n\n    // get the y position of the image relative to the group\n    var imageRelativeY = this.image.y();\n\n    // add the values together to get the absolute y position of the image\n    var imageY = groupY + imageRelativeY;\n\n    // get the group\n    var group = this.getGroup();\n\n    // check if the group is shifted\n    if (group != null) {\n      // get the bounding box of the group\n      var bbox = group.bbox();\n\n      // get the y position of the bounding box on the group\n      var bboxY = bbox.y;\n\n      // compensate for the shift of the group\n      imageY = imageY - bboxY;\n    }\n\n    return imageY;\n  }\n\n  /**\n   * Get the width of the image\n   * @returns the width of th eimage\n   */\n  getImageWidth() {\n    var width = 0;\n\n    if (this.image != null) {\n      width = this.image.width();\n    }\n\n    return width\n  }\n\n  /**\n   * Get the height of the image\n   * @returns the height of the image\n   */\n  getImageHeight() {\n    var height = 0;\n\n    if (this.image != null) {\n      height = this.image.height();\n    }\n\n    return height;\n  }\n\n  /**\n   * Set the mouseover listener for the group\n   * @param nodeMouseOverFunction the function to call when the mouse is over\n   * the group\n   */\n  setNodeMouseOver(nodeMouseOverFunction) {\n\n    if (this.group != null) {\n      this.group.mouseover(nodeMouseOverFunction);\n    }\n  }\n\n  /**\n   * Set the mouseout listener for the group\n   * @param nodeMouseOutFunction the function to call when the mouse moves\n   * out of the group\n   */\n  setNodeMouseOut(nodeMouseOutFunction) {\n\n    if (this.group != null) {\n      this.group.mouseout(nodeMouseOutFunction);\n    }\n  }\n\n  /**\n   * Set the mousedown listener for the group\n   * @param nodeMouseDownFunction the function to call when the mouse is\n   * down on the group\n   */\n  setNodeMouseDown(nodeMouseDownFunction) {\n\n    if (this.group != null) {\n      this.group.mousedown(nodeMouseDownFunction);\n    }\n  }\n\n  /**\n   * Set the mouseup listener for the group\n   * @param nodeMouseUpFunction the function to call when the mouse is\n   * released over the group\n   */\n  setNodeMouseUp(nodeMouseUpFunction) {\n\n    if (this.group != null) {\n      this.group.mouseup(nodeMouseUpFunction);\n    }\n  }\n\n  /**\n   * Set the click listener for the image\n   * @param nodeMouseClickFunction the function to call when the image is\n   * clicked\n   */\n  setNodeMouseClick(nodeMouseClickFunction) {\n\n    if (this.group != null) {\n      this.image.click(nodeMouseClickFunction);\n    }\n  }\n\n  /**\n   * Set the mousedown listener for the connector\n   * @param connectorMouseDownFunction the function to call when the mouse\n   * is down on the connector\n   */\n  setConnectorMouseDown(connectorMouseDownFunction) {\n\n    if (this.connector != null) {\n      this.connector.mousedown(connectorMouseDownFunction);\n    }\n  }\n\n  /**\n   * Set the mousedown listener for the delete button\n   * @param deleteButtonMouseDownFunction the function to call when the mouse\n   * is down on the delete button\n   */\n  setDeleteButtonMouseDown(deleteButtonMouseDownFunction) {\n\n    if (this.deleteButtonCircle != null) {\n      this.deleteButtonCircle.mousedown(deleteButtonMouseDownFunction);\n    }\n  }\n\n  /**\n   * Set the mouseover listener for the delete button\n   * @param deleteButtonMouseOverFunction the function to call when the mouse\n   * is over the delete button\n   */\n  setDeleteButtonMouseOver(deleteButtonMouseOverFunction) {\n\n    if (this.deleteButtonCircle != null) {\n      this.deleteButtonCircle.mouseover(deleteButtonMouseOverFunction);\n    }\n  }\n\n  /**\n   * Set the mouseout listener for the delete button\n   * @param deleteButtonMouseOutFunction the function to call when the mouse\n   * moves out of the delete button\n   */\n  setDeleteButtonMouseOut(deleteButtonMouseOutFunction) {\n\n    if (this.deleteButtonCircle != null) {\n      this.deleteButtonCircle.mouseout(deleteButtonMouseOutFunction);\n    }\n  }\n\n  /**\n   * Set the dragmove listener for the group\n   * @param dragMoveFunction the function to call when the group is dragged\n   */\n  setDragMove(dragMoveFunction) {\n\n    if (this.group != null) {\n\n      // set a listener for when the node is dragged\n      this.group.on('dragmove', dragMoveFunction);\n    }\n  }\n\n  /**\n   * Set the x position\n   * @param x the x position\n   */\n  setX(x) {\n    this.x = x;\n    this.group.x(x);\n  }\n\n  /**\n   * Set the y position\n   * @param y the y position\n   */\n  setY(y) {\n    this.y = y;\n    this.group.y(y);\n  }\n\n  /**\n   * Add an outgoing link to the node\n   * @param outgoingLink a ConceptMapLink object\n   */\n  addOutgoingLink(outgoingLink) {\n    if (outgoingLink != null) {\n      this.outgoingLinks.push(outgoingLink);\n    }\n  }\n\n  /**\n   * Remove an outgoing link from the node\n   * @param outgoingLink a ConceptMapLink object\n   */\n  removeOutgoingLink(outgoingLink) {\n\n    if (outgoingLink != null) {\n\n      // loop through all the outgoing links in this node\n      for (var ol = 0; ol < this.outgoingLinks.length; ol++) {\n\n        // get an outgoing link\n        var tempOutgoingLink = this.outgoingLinks[ol];\n\n        if (outgoingLink == tempOutgoingLink) {\n          // we have found the outgoing link we want to remove\n          this.outgoingLinks.splice(ol, 1);\n          break;\n        }\n      }\n    }\n  }\n\n  /**\n   * Get the outgoing links\n   * @return the outgoing links\n   */\n  getOutgoingLinks() {\n    return this.outgoingLinks;\n  }\n\n  /**\n   * Add an incoming link to the node\n   * @param incomingLink a ConceptMapLink object\n   */\n  addIncomingLink(incomingLink) {\n    if (incomingLink != null) {\n      this.incomingLinks.push(incomingLink);\n    }\n  }\n\n  /**\n   * Remove an incoming link from the node\n   * @param incomingLink a ConceptMapLink object\n   */\n  removeIncomingLink(incomingLink) {\n\n    if (incomingLink != null) {\n\n      // loop through the incoming links in the node\n      for (var il = 0; il < this.incomingLinks.length; il++) {\n\n        // get an incoming link\n        var tempIncomingLink = this.incomingLinks[il];\n\n        if (incomingLink == tempIncomingLink) {\n          // we have found the incoming link we want to remove\n          this.incomingLinks.splice(il, 1);\n          break;\n        }\n      }\n    }\n  }\n\n  /**\n   * Get the incoming links\n   * @return the incoming links\n   */\n  getIncomingLinks() {\n    return this.incomingLinks;\n  }\n\n  /**\n   * The function that is called when the node is moved\n   * @param event\n   */\n  dragMove(event) {\n\n    // get the group\n    var group = this.getGroup();\n\n    // get the x and y coordinates of the center of the image\n    var cx = this.cx();\n    var cy = this.cy();\n\n    // update the local x, y values of the node for bookkeeping\n    this.x = group.x();\n    this.y = group.y();\n\n    // get the outgoing links and incoming links\n    var outgoingLinks = this.outgoingLinks;\n    var incomingLinks = this.incomingLinks;\n\n    if (outgoingLinks != null) {\n\n      // loop through all the outgoing links\n      for (var ol = 0; ol < outgoingLinks.length; ol++) {\n\n        // get an outgoing link\n        var outgoingLink = outgoingLinks[ol];\n\n        // update the x, y coordinate of the tail of the link\n        var x1 = cx;\n        var y1 = cy;\n\n        // calculate the nearest point to the destination node\n        var nearestPoint = outgoingLink.getNearestPointToDestinationNode(x1, y1);\n        x2 = nearestPoint.x;\n        y2 = nearestPoint.y;\n\n        // update the coordinates of the link\n        outgoingLink.updateCoordinates(x1, y1, x2, y2);\n      }\n\n      // loop through all the incoming links\n      for (var il = 0; il < incomingLinks.length; il++) {\n\n        // get an incoming link\n        var incomingLink = incomingLinks[il];\n\n        // reuse the coordinates of the tail of the link\n        var x1 = incomingLink.x1();\n        var y1 = incomingLink.y1();\n\n        // calculate the nearest point to the source node\n        var nearestPoint = incomingLink.getNearestPointToDestinationNode(x1, y1);\n        var x2 = nearestPoint.x;\n        var y2 = nearestPoint.y;\n\n        // update the coordinates of the link\n        incomingLink.updateCoordinates(x1, y1, x2, y2);\n      }\n    }\n\n    if (this.controller != null) {\n      // handle the student data changing\n      this.controller.studentDataChanged();\n    }\n\n    // move the group to the front so that it shows up above other elements\n    group.front();\n  }\n\n  /**\n   * Remove the node from the svg\n   */\n  remove() {\n\n    // make the group not draggable\n    this.group.draggable(false);\n\n    // remove the group\n    this.group.remove();\n\n    // remove the image\n    this.image.remove();\n\n    // remove the connector\n    this.connector.remove();\n\n    // remove the delete button\n    this.deleteButtonCircle.remove();\n    this.deleteButtonX.remove();\n    this.deleteButtonGroup.remove();\n\n    // loop through all the outgoing links\n    for (var ol = 0; ol < this.outgoingLinks.length; ol++) {\n\n      // get an outgoing link\n      var outgoingLink = this.outgoingLinks[ol];\n\n      if (outgoingLink != null) {\n        // remove the outgoing link\n        outgoingLink.remove();\n\n        /*\n         * move the counter back one because calling outgoingLink.remove()\n         * has removed the outgoingLink from the outgoingLinks array\n         */\n        ol--;\n      }\n    }\n\n    // loop through all the incoming links\n    for (var il = 0; il < this.incomingLinks.length; il++) {\n\n      // get an incoming link\n      var incomingLink = this.incomingLinks[il];\n\n      if (incomingLink != null) {\n        // remove the incoming link\n        incomingLink.remove();\n\n        /*\n         * move the counter back one because calling incomingLink.remove()\n         * has removed the incomingLink from the incomingLinks array\n         */\n        il--;\n      }\n    }\n  }\n\n  /**\n   * Get the links from this node to a given destination node\n   * @param destinationNode the destination node\n   */\n  getLinksToDestination(destinationNode) {\n\n    var linksToDestination = [];\n\n    // loop through all the outgoing links\n    for (var ol = 0; ol < this.outgoingLinks.length; ol++) {\n\n      // get an outgoing link\n      var outgoingLink = this.outgoingLinks[ol];\n\n      if (outgoingLink != null) {\n        if (destinationNode == outgoingLink.destinationNode) {\n          /*\n           * the destination of the link is the destination we are\n           * looking for\n           */\n          linksToDestination.push(outgoingLink);\n        }\n      }\n    }\n\n    return linksToDestination;\n  }\n\n  /**\n   * Calculate the width that the text rectangle should be set to\n   * @param labelText the label text that will be displayed in the rectangle\n   * @return the width that the text rectangle should be set to\n   */\n  calculateTextRectWidth(labelText) {\n    var width = 0;\n\n    if (labelText != null) {\n      width = (labelText.length * 6) + 10;\n    }\n\n    return width;\n  }\n\n  // end of ConceptMapNode class\n}\n\n/**\n * A ConceptMapLink that represents a link in the ConceptMap component\n */\nclass ConceptMapLink {\n\n  /**\n   * The constructor to create a ConceptMapLink object\n   * @param ConceptMapService the ConceptMapService\n   * @param draw the svg.js draw object\n   * @param id the instance id of the link\n   * @param originalId the original authored id of the link\n   * @param sourceNode the source ConceptMapNode\n   * @param destinationNode the destination ConceptMapNode\n   * @param label the text label\n   * @param color the color of the link\n   * @param curvature the curvature of the link\n   * @param startCurveUp whether the start of the link curves up\n   * @param endCurveUp whether the end of the link curves up\n   */\n  constructor(ConceptMapService, draw, id, originalId, sourceNode, destinationNode, label, color, curvature, startCurveUp, endCurveUp) {\n\n    // remember the ConceptMapService\n    this.ConceptMapService = ConceptMapService;\n\n    // remember the svg.js draw object\n    this.draw = draw;\n\n    // set the id\n    this.id = id;\n\n    // set the original id\n    this.originalId = originalId;\n\n    // the arrow head of the link\n    this.head = null;\n\n    // the line of the link\n    this.path = null;\n\n    // set the color of the link\n    this.color = color;\n\n    if (this.color == null) {\n      // if no color is specified, use a default color\n      this.color = 'blue';\n    }\n\n    // whether the link is highlighted\n    this.highlighted = false;\n\n    // create a group to contain the path and head\n    this.group = this.draw.group();\n\n    // where to place the text of the link along the line\n    this.textPercentageLocationOnLink = 0.6\n\n    // remember the source node\n    this.sourceNode = sourceNode;\n\n    /*\n     * used to remember the destination node later after the destination\n     * node has been chosen\n     */\n    this.destinationNode = destinationNode;\n\n    // remember the curvature\n    this.curvature = curvature;\n\n    if (this.curvature == null) {\n      this.curvature = 0.5;\n    }\n\n    // set whether the link curves up or down\n    this.startCurveUp = startCurveUp;\n    this.endCurveUp = endCurveUp;\n\n    if (this.startCurveUp == null || this.endCurveUp == null) {\n      /*\n       * start and end curve up have not been specified so we will set\n       * it at random\n       */\n\n      // choose a random integer 0 or 1\n      var randInt = Math.floor(Math.random() * 2);\n\n      if (randInt == 0) {\n        // set the link to curve down\n        this.startCurveUp = false;\n        this.endCurveUp = false;\n      } else {\n        // set the link to curve up\n        this.startCurveUp = true;\n        this.endCurveUp = true;\n      }\n    }\n\n    // create a curved link\n    this.curvedLink = true;\n\n    // initialize the coordinates of both ends of the link\n    var x1 = this.sourceNode.cx();\n    var y1 = this.sourceNode.cy();\n    var x2 = x1;\n    var y2 = y1;\n\n    if (this.destinationNode != null) {\n\n      /*\n       * get the nearest point from the center of the source node to the\n       * destination node along the perimeter of the destination node\n       * image\n       */\n      var nearestPoint = this.getNearestPointToDestinationNode(x1, y1);\n      x2 = nearestPoint.x;\n      y2 = nearestPoint.y;\n\n      // connect the link to the nodes\n      this.connectLinkToNodes();\n    }\n\n    if (this.curvedLink) {\n      // create a curved link\n\n      // calculate the curved line in svg\n      var arrowPathArraysObject = this.calculateCurvedLine(x1, y1, x2, y2);\n\n      // get the line\n      var tail = arrowPathArraysObject[0];\n\n      // get the arrow head\n      var head = arrowPathArraysObject[1];\n\n      // draw the head and tail\n      this.head = this.draw.path(head.toString());\n      this.path = this.draw.path(tail.toString());\n    } else {\n      // create a straight line\n      this.path = this.draw.path('M' + x1 + ',' + y1 + ' L' + x2 + ',' + y2);\n    }\n\n    // set the style of the link\n    this.path.attr('stroke', this.color);\n    this.path.attr('stroke-width', 3);\n    this.path.attr('fill', 'transparent');\n    this.head.attr('stroke', this.color);\n    this.head.attr('fill', this.color);\n    this.head.attr('pointer-events', 'none');\n\n    /*\n     * remember the x and y coordinates of the source and destination\n     * so that we can look them up easily later\n     */\n    this.path.attr('x1', x1);\n    this.path.attr('y1', y1);\n    this.path.attr('x2', x2);\n    this.path.attr('y2', y2);\n\n    // add the tail and head to the group\n    this.group.add(this.path);\n    this.group.add(this.head);\n\n    // create the text group for the link\n    this.createTextGroup();\n\n    // text that describes the type of link chosen by the student\n    this.setLabel(label);\n\n    if (this.label == null || this.label == '') {\n      // there is no label so we will hide the text group\n      this.hideTextGroup();\n    } else {\n      // there is a label so we will show the text group\n      this.showTextGroup();\n    }\n\n    // create the delete button group\n    this.createDeleteButtonGroup();\n  }\n\n  /**\n   * Get the JSON object representation of the ConceptMapLink\n   * @returns a JSON object containing the data of the ConceptMapLink\n   */\n  toJSONObject() {\n    var jsonObject = {};\n\n    jsonObject.originalId = this.originalId;\n    jsonObject.instanceId = this.id;\n    jsonObject.color = this.color;\n    jsonObject.label = this.label;\n    jsonObject.curvature = this.curvature;\n    jsonObject.startCurveUp = this.startCurveUp;\n    jsonObject.endCurveUp = this.endCurveUp;\n    jsonObject.sourceNodeOriginalId = this.sourceNode.getOriginalId();\n    jsonObject.sourceNodeInstanceId = this.sourceNode.getId();\n    jsonObject.sourceNodeLabel = this.sourceNode.getLabel();\n    jsonObject.destinationNodeOriginalId = this.destinationNode.getOriginalId();\n    jsonObject.destinationNodeInstanceId = this.destinationNode.getId();\n    jsonObject.destinationNodeLabel = this.destinationNode.getLabel();\n\n    return jsonObject;\n  }\n\n  /**\n   * Get the id of the link\n   * @returns the id of the link\n   */\n  getId() {\n    return this.id;\n  }\n\n  /**\n   * Get the original id of the node\n   * @returns the original id of the node\n   */\n  getOriginalId() {\n    return this.originalId;\n  }\n\n  /**\n   * Get the id of the group\n   * @returns the id of the group\n   */\n  getGroupId() {\n    return this.group.id();\n  }\n\n  /**\n   * Get the x1 value\n   * @returns the x coordinate of the source of the link\n   */\n  x1() {\n    return this.path.attr('x1');\n  }\n\n  /**\n   * Get the y1 value\n   * @returns the y coordinate of the source of the link\n   */\n  y1() {\n    return this.path.attr('y1');\n  }\n\n  /**\n   * Get the x2 value\n   * @returns the x coordinate of the destination of the link\n   */\n  x2() {\n    return this.path.attr('x2');\n  }\n\n  /**\n   * Get the y2 value\n   * @returns the y coordinate of the destination of the link\n   */\n  y2() {\n    return this.path.attr('y2');\n  }\n\n  /**\n   * Set the original id\n   * @param originalId the original id\n   */\n  setOriginalId(originalId) {\n    this.originalId = originalId;\n  }\n\n  /**\n   * Get the label\n   * @returns the label\n   */\n  getLabel() {\n    return this.label;\n  }\n\n  /**\n   * Getter/setter for the highlighted value\n   * @param value (optional) the highlighted value\n   * @returns whether the link is highlighted\n   */\n  isHighlighted(value) {\n\n    if (value != null) {\n      this.highlighted = value;\n    }\n\n    return this.highlighted;\n  }\n\n  /**\n   * Update the coordinates of the link\n   * @param x1 (optional) the x position of the source\n   * @param y1 (optional) the y position of the source\n   * @param x2 (optional) the x position of the destination\n   * @param y2 (optional) the y position of the destination\n   * @param isDragging whether the link is currently being dragged\n   */\n  updateCoordinates(x1, y1, x2, y2, isDragging) {\n    var array = this.path.array();\n\n    if (this.curvedLink) {\n      // draw a curved link\n\n      if (x1 == null) {\n        /*\n         * the x1 parameter was not provided so we will reuse the\n         * existing value\n         */\n        x1 = this.path.attr('x1');\n      }\n\n      if (y1 == null) {\n        /*\n         * the y1 parameter was not provided so we will reuse the\n         * existing value\n         */\n        y1 = this.path.attr('y1');\n      }\n\n      if (x2 == null) {\n        /*\n         * the x2 parameter was not provided so we will reuse the\n         * existing value\n         */\n        x2 = this.path.attr('x2');\n      }\n\n      if (y2 == null) {\n        /*\n         * the y2 parameter was not provided so we will reuse the\n         * existing value\n         */\n        y2 = this.path.attr('y2');\n      }\n\n      // calculate the line\n      var arrowPathArraysObject = this.calculateCurvedLine(x1, y1, x2, y2, isDragging);\n\n      // get the svg tail\n      var tail = arrowPathArraysObject[0];\n\n      // get the svg head\n      var head = arrowPathArraysObject[1];\n\n      // re-plot the head and path\n      this.head.plot(head.toString());\n      this.path.plot(tail.toString());\n    } else {\n      // draw a straight line\n\n      if (x1 == null) {\n        /*\n         * the x1 parameter was not provided so we will reuse the\n         * existing value\n         */\n        x1 = this.path.attr('x1');\n      }\n\n      if (y1 == null) {\n        /*\n         * the y1 parameter was not provided so we will reuse the\n         * existing value\n         */\n        y1 = this.path.attr('y1');\n      }\n\n      if (x2 == null) {\n        /*\n         * the x2 parameter was not provided so we will reuse the\n         * existing value\n         */\n        x2 = this.path.attr('x2');\n      }\n\n      if (y2 == null) {\n        /*\n         * the y2 parameter was not provided so we will reuse the\n         * existing value\n         */\n        y2 = this.path.attr('y2');\n      }\n\n      // re-plot the line\n      this.path.plot('M' + x1 + ',' + y1 + ' L' + x2 + ',' + y2);\n    }\n\n    // update the coordinate values\n    this.path.attr('x1', x1);\n    this.path.attr('y1', y1);\n    this.path.attr('x2', x2);\n    this.path.attr('y2', y2);\n\n    if (this.deleteButtonGroup != null) {\n      // update the location of the delete button\n      var deleteButtonLocation = this.getDeleteButtonLocation();\n      this.deleteButtonGroup.x(deleteButtonLocation.x);\n      this.deleteButtonGroup.y(deleteButtonLocation.y);\n    }\n\n    if (this.textGroup != null) {\n      // update the location of the text group\n\n      // get the length of the line\n      var totalLength = this.path.node.getTotalLength();\n\n      // get the coordinate of a point somewhere in the middel of the line\n      var midPoint = this.path.node.getPointAtLength(totalLength * this.textPercentageLocationOnLink);\n\n      this.textGroup.cx(midPoint.x);\n      this.textGroup.cy(midPoint.y);\n    }\n  }\n\n  /**\n   * Calculate the curved line\n   * @param x1 the x coordinate of the source\n   * @param y1 the y coordinate of the source\n   * @param x2 the x coordinate of the destination\n   * @param y2 the y coordinate of the destination\n   * @param isDragging whether the line is currently being dragged\n   * @returns an array that contains the svg objects for the arrow head and line\n   */\n  calculateCurvedLine(x1, y1, x2, y2, isDragging) {\n\n    var startx = x1;\n    var starty = y1;\n    var endx = x2;\n    var endy = y2;\n    var startCurveUp = true;\n    var endCurveUp = true;\n    var len = 15;\n    var angle = 45;\n    var curvature = 0.5;\n    var nodeRadius = 10;\n\n    // set the amount of curvature of the line\n    curvature = this.curvature;\n\n    // whether the link should curve up or down\n    startCurveUp = this.startCurveUp;\n    endCurveUp = this.endCurveUp;\n\n    // calculate the svg objects for the arrow head and line\n    var arrowPathArraysObject = this.ConceptMapService.arrowPathArrays(startx,starty,endx,endy,startCurveUp,endCurveUp,len,angle,curvature,nodeRadius);\n\n    return arrowPathArraysObject;\n  }\n\n  /**\n   * Set the destination node\n   * @param destinationNode the destination ConceptMapNode object\n   */\n  setDestination(destinationNode) {\n\n    if (destinationNode != null) {\n\n      // get x and y of the tail\n      var x1 = this.path.attr('x1');\n      var y1 = this.path.attr('y1');\n\n      // remember the destination node\n      this.destinationNode = destinationNode;\n\n      /*\n       * check if there are any links with that have the same source,\n       * destination, and direction. if there is a link that has the\n       * same source, destination, and direction, we will try to use\n       * a different direction that hasn't already been used. if all\n       * directions have already been used, we will use the original\n       * direction the user specified. there are three link directions,\n       * up, straight, and down.\n       *    ___\n       * up  /   \\\n       *  o  o\n       *\n       * straight o------o\n       *\n       *    o   o\n       * down \\__/\n       */\n\n      var directionAlreadyUsed = false;\n      var direction = '';\n\n      if (this.curvature == 0) {\n        // the user has created the curve to be straight\n        direction = 'straight';\n      } else if (this.startCurveUp && this.endCurveUp) {\n        // the user has created the curve that starts by pointing up\n        direction = 'up';\n      } else if (!this.startCurveUp && !this.endCurveUp) {\n        // the user has created the curve that starts by pointing down\n        direction = 'down';\n      }\n\n      // get all the links that have the same source and destination\n      var parallelLinks = this.sourceNode.getLinksToDestination(destinationNode);\n\n      var usedDirections = [];\n\n      // loop through all the links that have the same source and destination\n      for (var p = 0; p < parallelLinks.length; p++) {\n        var parallelLink = parallelLinks[p];\n\n        if (parallelLink != null) {\n\n          var curvature = parallelLink.curvature;\n          var startCurveUp = parallelLink.startCurveUp;\n          var endCurveUp = parallelLink.endCurveUp;\n\n          var tempDirection = '';\n\n          if (curvature == 0) {\n            // the other link is straight\n            tempDirection = 'straight';\n          } else if (startCurveUp && endCurveUp) {\n            // the other link points up\n            tempDirection = 'up';\n          } else if (!startCurveUp && !endCurveUp) {\n            // the other link points down\n            tempDirection = 'down'\n          }\n\n          if (direction == tempDirection) {\n            /*\n             * the direction is the same as the direction the user\n             * has specified\n             */\n            directionAlreadyUsed = true;\n          }\n\n          // keep track of the directions that were used\n          usedDirections.push(tempDirection);\n        }\n      }\n\n      if (directionAlreadyUsed) {\n        /*\n         * the direction the user specified is already used so we will\n         * try to find a direction that hasn't been used\n         */\n\n        if (usedDirections.indexOf('up') == -1) {\n          /*\n           * we have not used the up direction yet so we will make\n           * the link point up\n           */\n          this.curvature = 0.5;\n          this.startCurveUp = true;\n          this.endCurveUp = true;\n        } else if (usedDirections.indexOf('straight') == -1) {\n          /*\n           * we have not used the straight direction yet so we will\n           * make the link point straight\n           */\n          this.curvature = 0.0;\n          this.startCurveUp = true;\n          this.endCurveUp = true;\n        } else if (usedDirections.indexOf('down') == -1) {\n          /*\n           * we have not used the down direction yet so we will make\n           * the link point down\n           */\n          this.curvature = 0.5;\n          this.startCurveUp = false;\n          this.endCurveUp = false;\n        }\n      }\n\n      /*\n       * get the nearest point from the center of the source node to the\n       * destination node along the perimeter of the destination node\n       * image\n       */\n      var nearestPoint = this.getNearestPointToDestinationNode(x1, y1);\n      var x2 = nearestPoint.x;\n      var y2 = nearestPoint.y;\n\n      // update the coordinates of the link\n      var isDragging = false;\n      this.updateCoordinates(x1, y1, x2, y2, isDragging);\n\n      // connect the link to the nodes\n      this.connectLinkToNodes();\n\n      // hide the delete button\n      this.hideDeleteButton();\n    }\n  }\n\n  /**\n   * Get the nearest point to the destination node from a given x, y point\n   * @param x the x value of the source point\n   * @param y the y value of the source point\n   * @returns an object containing an x and y field\n   */\n  getNearestPointToDestinationNode(x, y) {\n\n    // get the coordinates of the upper left corner of the image\n    var rectMinX = this.destinationNode.getImageX();\n    var rectMinY = this.destinationNode.getImageY();\n\n    /*\n     * add padding of 25 pixels to resolve the problem of the arrow head\n     * being placed behind the destination image\n     */\n    rectMinY = rectMinY - 25;\n\n    // get the width and height of the image\n    var width = this.destinationNode.getImageWidth();\n    var height = this.destinationNode.getImageHeight();\n\n    // compensate for the 25 pixel padding that we added above\n    height = height + 25;\n\n    /*\n    var destinationNodeGroup = this.destinationNode.getGroup();\n    var destinationNodeGroupBBox = destinationNodeGroup.bbox();\n\n    rectMinX = this.destinationNode.getGroupX();\n    rectMinY = this.destinationNode.getGroupY();\n\n    width = destinationNodeGroupBBox.width;\n    height = destinationNodeGroupBBox.height;\n    */\n\n    if (x == null && y == null) {\n      // get the coordinates of the source if x and y were not provided\n      x = this.path.attr('x1');\n      y = this.path.attr('y1');\n    }\n\n    /*\n     * find the nearest point from the source to anywhere along the\n     * rectangular perimeter of the destination image\n     */\n    var point = this.getNearestPointInPerimeter(rectMinX, rectMinY, width, height, x, y);\n\n    return point;\n  }\n\n  /**\n   * Get the nearest point on a rectangle from a source point\n   * @param l the upper left x value of the rectangle\n   * @param t the upper left y value of the rectangle\n   * @param w the width of the rectangle\n   * @param h the height of the rectangle\n   * @param x the source point x value\n   * @param y the source point y value\n   * @returns the point on the rectangle that is closest to the\n   */\n  getNearestPointInPerimeter(l, t, w, h, x, y) {\n    var r = l + w;\n    var b = t + h;\n\n    var x = this.clamp(x, l , r);\n    var y = this.clamp(y, t, b);\n\n    var dl = Math.abs(x - l);\n    var dr = Math.abs(x - r);\n    var dt = Math.abs(y - t);\n    var db = Math.abs(y - b);\n\n    var m = Math.min(dl, dr, dt, db);\n\n    var point = {};\n\n    if (m == dt) {\n      point.x = x;\n      point.y = t;\n    } else if (m == db) {\n      point.x = x;\n      point.y = b;\n    } else if (m == dl) {\n      point.x = l;\n      point.y = y;\n    } else {\n      point.x = r;\n      point.y = y;\n    }\n\n    return point;\n  }\n\n  /**\n   * Helper function for getNearestPointInPerimeter\n   */\n  clamp(x, lower, upper) {\n    return Math.max(lower, Math.min(upper, x));\n  }\n\n  /**\n   * Set the color of the link\n   * @param color the color\n   */\n  setColor(color) {\n\n    if (color != null) {\n      // set the color styling\n      this.color = color;\n      this.path.attr('stroke', this.color);\n      this.head.attr('stroke', this.color);\n      this.head.attr('fill', this.color);\n      this.deleteButton.attr('stroke', this.color);\n      this.deleteButtonX.attr('stroke', this.color);\n    }\n  }\n\n  /**\n   * Set the label\n   * @param label the text label\n   */\n  setLabel(label) {\n\n    if (label != null) {\n\n      // remember the label\n      this.label = label;\n\n      // set the text into the text element\n      this.text.text(label);\n\n      // show the text group now that it has a label\n      this.showTextGroup();\n\n      // reset the width to adjust to the new text length\n      var width = 0;\n\n      try {\n        // get the width of the bounding box of the text node\n        var textBBox = this.text.node.getBBox();\n\n        if (textBBox.width == 0) {\n          width = this.calculateTextRectWidth(this.label);\n        } else {\n          width = textBBox.width + 10;\n        }\n      } catch(e) {\n        /*\n         * we were unable to get the bounding box (likely because\n         * Firefox threw an error when trying to call getBBox())\n         * so we will calculate the width based on the label text\n         */\n        width = this.calculateTextRectWidth(this.label);\n      }\n\n      this.textRect.attr('width', width);\n\n      // recalculate the position of the svg text object\n      var totalLength = this.path.node.getTotalLength();\n      var midPoint = this.path.node.getPointAtLength(totalLength * this.textPercentageLocationOnLink);\n      this.textGroup.cx(midPoint.x);\n      this.textGroup.cy(midPoint.y);\n    }\n  }\n\n  /**\n   * Connect a link the its source and destination nodes\n   */\n  connectLinkToNodes() {\n\n    if (this.sourceNode != null && this.destinationNode != null) {\n\n      // add the link to the outgoing links of its source node\n      this.sourceNode.addOutgoingLink(this);\n\n      // add the link to the incoming links of its destination node\n      this.destinationNode.addIncomingLink(this);\n    }\n  }\n\n  /**\n   * Create the delete button for the link\n   */\n  createDeleteButtonGroup() {\n    // create a group to contain the elements of the delete button\n    this.deleteButtonGroup = this.draw.group();\n\n    /*\n     * create an invisible circle that is placed behind the delete button\n     * and has a larger radius than the delete button. this is used for\n     * mouse over purposes so that we can keep the delete button visible\n     * when the mouse is around the area of the delete button\n     */\n    var invisibleCircleRadius = 30;\n    this.invisibleCircle = this.draw.circle();\n    this.invisibleCircle.radius(invisibleCircleRadius);\n    this.invisibleCircle.fill({ opacity: 0.0});\n\n    // create the delete button circle\n    var deleteButtonRadius = 10;\n    this.deleteButton = this.draw.circle();\n    this.deleteButton.radius(deleteButtonRadius);\n    this.deleteButton.fill({ opacity: 0.0 });\n    this.deleteButton.stroke({ color: this.color, opacity: 1.0, width: 2 });\n\n    /*\n     * create the x part of the delete button by creating a + and then\n     * rotating it 45 degrees\n     */\n\n    // get the coordinate of the center of the delete button\n    var deleteButtonMidpointX = this.deleteButton.cx();\n    var deleteButtonMidpointY = this.deleteButton.cy();\n\n    // get the coordinates of the top of the +\n    var topX = deleteButtonMidpointX;\n    var topY = deleteButtonMidpointY - (deleteButtonRadius * 0.7);\n\n    // get the coordinates of the bottom of the +\n    var bottomX = deleteButtonMidpointX;\n    var bottomY = deleteButtonMidpointY + (deleteButtonRadius * 0.7);\n\n    // get the coordinates of the left of the +\n    var leftX = deleteButtonMidpointX - (deleteButtonRadius * 0.7);\n    var leftY = deleteButtonMidpointY;\n\n    // get the coordinates of the right of the +\n    var rightX = deleteButtonMidpointX + (deleteButtonRadius * 0.7);\n    var rightY = deleteButtonMidpointY;\n\n    // create the path for the +\n    var deleteButtonXPath = 'M' + topX + ',' + topY + 'L' + bottomX + ',' + bottomY + 'M' + leftX + ',' + leftY + 'L' + rightX + ',' + rightY;\n\n    // draw the path\n    this.deleteButtonX = this.draw.path(deleteButtonXPath);\n    this.deleteButtonX.stroke({ color: this.color, opacity: 1.0, width: 2 });\n\n    /// rotate the + to create the x\n    this.deleteButtonX.rotate(45);\n\n    /*\n     * disable pointer events on the x so that we only need to set a\n     * mouse listener on the circle\n     */\n    this.deleteButtonX.attr('pointer-events', 'none');\n\n    // add the invisible circle, regular circle, and x to the group\n    this.deleteButtonGroup.add(this.invisibleCircle);\n    this.deleteButtonGroup.add(this.deleteButton);\n    this.deleteButtonGroup.add(this.deleteButtonX);\n\n    // set the location of the delete button group\n    var location = this.getDeleteButtonLocation();\n    var x = location.x;\n    var y = location.y;\n    this.deleteButtonGroup.x(x);\n    this.deleteButtonGroup.y(y);\n\n    // set the listener for when the mouse is over the group\n    this.deleteButtonGroup.mouseover((event) => {\n      this.deleteButtonGroupMouseOver(event);\n    });\n\n    // set the listener for when the mouse moves out of the group\n    this.deleteButtonGroup.mouseout((event) => {\n      this.deleteButtonGroupMouseOut(event);\n    });\n\n    // add the delete button group to the link group\n    this.group.add(this.deleteButtonGroup);\n\n    /*\n     * hide the delete button. we only need to show the delete button\n     * when the link is active.\n     */\n    this.deleteButtonGroup.hide();\n  }\n\n  /**\n   * Called when the mouse is over the delete button group\n   * @param event the mouseover event\n   */\n  deleteButtonGroupMouseOver(event) {\n    // show the delete button\n    this.showDeleteButton();\n  }\n\n  /**\n   * Called when the mouse leaves the delete button group\n   * @param event the mouseout event\n   */\n  deleteButtonGroupMouseOut(event) {\n    if (!this.highlighted) {\n      // the link is not highlighted so we will hide the delete button\n      this.hideDeleteButton();\n    }\n  }\n\n  /**\n   * Called when the delete button is clicked\n   * @param deleteButtonClickedFunction the function to call when the delete\n   * button is clicked\n   */\n  setDeleteButtonClicked(deleteButtonClickedFunction) {\n    // listen for the click event on the delete button to call the function\n    this.deleteButton.click(deleteButtonClickedFunction);\n  }\n\n  /**\n   * Called when the mouse is clicked down on the group\n   * @param linkMouseDownFunction the function to call when the mouse is\n   * clicked down on the group\n   */\n  setLinkMouseDown(linkMouseDownFunction) {\n\n    if (this.group != null) {\n      /*\n       * listen for the mousedown event on the group to call\n       * the function\n       */\n      this.group.mousedown(linkMouseDownFunction);\n    }\n  }\n\n  /**\n   * Called when the mouse is clicked down on the link text group\n   * @param linkTextMouseDownFunction the function to call when the mouse is\n   * clicked down on the link text group\n   */\n  setLinkTextMouseDown(linkTextMouseDownFunction) {\n\n    if (this.textGroup != null) {\n      /*\n       * listen for the mousedown event on the link text group to call\n       * the function\n       */\n      this.textGroup.mousedown(linkTextMouseDownFunction);\n    }\n  }\n\n  /**\n   * Called when the mouse is over the group\n   * @param linkMouseOverFunction the function to call when the mouse is over\n   * the group\n   */\n  setLinkMouseOver(linkMouseOverFunction) {\n    if (this.group != null) {\n      // listen for the mouseover event on the group to call the function\n      this.group.mouseover(linkMouseOverFunction);\n    }\n  }\n\n  /**\n   * Called when the mouse leaves the group\n   * @param linkMouseOutFunction the function to call when the mouse leaves\n   * the group\n   */\n  setLinkMouseOut(linkMouseOutFunction) {\n    if (this.group != null) {\n      // listen for the mouseout event on the group to call the function\n      this.group.mouseout(linkMouseOutFunction);\n    }\n  }\n\n  /**\n  * Calculate the location of the delete button for the link\n  *\n  * Note: This function and the associated functions that are called by this\n  * function are taken from the Concord MySystem github project.\n  * https://github.com/concord-consortium/mysystem_sc\n  * The code is found in the _setRemoveButtonLocation function in the link.js file.\n  * mysystem_sc/apps/my_system/views/link.js\n  */\n  getDeleteButtonLocation() {\n    //var line = raphaelObject.items[2];\n\n    var line = this.path.node;\n    var distanceAlongLine = 35;\n    var distanceAlongNormal = 18;\n    var len, p1, p2, scale, dx, dy, x, y, occluded;\n\n    /*\n    var link = this.get('content');\n    if (!link.isComplete()) return;\n    if (line.attr('path').length < 1) return;   // this can happen after our content is destroyed\n    */\n\n    len = line.getTotalLength();\n    p2  = line.getPointAtLength(len);\n\n    if (len > 50) {\n      p1 = line.getPointAtLength(len - distanceAlongLine);\n\n      dx = p2.x - p1.x;\n      dy = p2.y - p1.y;\n      scale = distanceAlongNormal / distanceAlongLine * (dx > 0 ? 1 : -1);\n\n      x = p1.x + scale * dy;\n      y = p1.y - scale * dx;\n      //occluded = NO;\n    }\n    else {\n      x = 0;\n      y = 0;\n      //occluded = YES;\n    }\n\n    /*\n    this.set('removeButtonX', x);\n    this.set('removeButtonY', y);\n    this.set('isRemoveButtonOccluded', occluded);\n    */\n\n    var location = {};\n    location.x = x;\n    location.y = y;\n\n    return location;\n  }\n\n  /**\n   * Show the delete button\n   */\n  showDeleteButton() {\n    if (this.deleteButtonGroup != null) {\n      this.deleteButtonGroup.show();\n    }\n  }\n\n  /**\n   * Hide the delete button\n   */\n  hideDeleteButton() {\n    if (this.deleteButtonGroup != null) {\n      this.deleteButtonGroup.hide();\n    }\n  }\n\n  /**\n   * Create the text group\n   * @returns the text group\n   */\n  createTextGroup() {\n\n    // create the group\n    this.textGroup = this.draw.group();\n\n    // create a rectangle to surround the text\n    this.textRect = this.draw.rect(100, 15);\n    this.textRect.attr('fill', 'white');\n    this.textRect.attr('stroke', 'black');\n    this.textRect.attr('x', 0);\n    this.textRect.attr('y', 10);\n    this.textRect.attr('width', 100);\n    this.textRect.attr('height', 20);\n    this.textRect.radius(5);\n\n    var label = '';\n\n    // create the text element\n    this.text = this.draw.text(label);\n    this.text.attr('x', 5);\n    this.text.attr('y', 9);\n    this.text.font({\n      family: 'Arial',\n      size: 12\n    });\n\n    // prevent the text from being highlighted when the user drags the mouse\n    this.text.style('user-select:none');\n    this.text.node.setAttribute('user-select', 'none');\n    this.text.node.setAttribute('style', 'user-select:none');\n\n    // add the rectangle and text to the group\n    this.textGroup.add(this.textRect);\n    this.textGroup.add(this.text);\n\n    var width = 0;\n\n    try {\n      // get the width of the bounding box of the text node\n      var textBBox = this.text.node.getBBox();\n\n      if (textBBox.width == 0) {\n        width = this.calculateTextRectWidth(this.label);\n      } else {\n        width = textBBox.width + 10;\n      }\n    } catch(e) {\n      /*\n       * we were unable to get the bounding box (likely because\n       * Firefox threw an error when trying to call getBBox())\n       * so we will calculate the width based on the label text\n       */\n      width = this.calculateTextRectWidth(this.label);\n    }\n\n    this.textRect.attr('width', width);\n\n    // set the location of the text to be somewhere along the line of the link\n    var totalLength = this.path.node.getTotalLength();\n    var midPoint = this.path.node.getPointAtLength(totalLength * this.textPercentageLocationOnLink);\n    this.textGroup.cx(midPoint.x);\n    this.textGroup.cy(midPoint.y);\n\n    // hide the text group until the student has chosen a link type\n    this.textGroup.hide();\n\n    /*\n     * set the link group id into the text group so we can look it up\n     * later when the mouse is clicked down on the text group\n     */\n    this.textGroup.node.linkGroupId = this.group.id();\n\n    return this.textGroup;\n  }\n\n  /**\n   * Move the text group to the front so that it won't be blocked behind\n   * another element when the student tries to click on the text group.\n   */\n  moveTextGroupToFront() {\n    this.textGroup.front();\n  }\n\n  /**\n   * Show the text group\n   */\n  showTextGroup() {\n\n    if (this.textGroup != null) {\n      this.textGroup.show();\n    }\n  }\n\n  /**\n   * Hide the text group\n   */\n  hideTextGroup() {\n\n    if (this.textGroup != null) {\n      this.textGroup.hide();\n    }\n  }\n\n  /**\n   * Remove all the references to the link and also remove all the elements\n   * from the svg\n   */\n  remove() {\n\n    if (this.sourceNode != null) {\n      // remove the link from the source node's outgoing links\n      this.sourceNode.removeOutgoingLink(this);\n    }\n\n    if (this.destinationNode != null) {\n      // remove the link from the destination node's incoming links\n      this.destinationNode.removeIncomingLink(this);\n    }\n\n    if (this.path != null) {\n      // remove the line\n      this.path.remove();\n    }\n\n    if (this.head != null) {\n      // remove the arrow head\n      this.head.remove();\n    }\n\n    if (this.deleteButtonGroup != null) {\n      // remove the delete button group\n      this.deleteButtonGroup.remove();\n    }\n\n    if (this.textGroup != null) {\n      // remove the text group\n      this.textGroup.remove();\n    }\n\n    if (this.group != null) {\n      // remove the link group\n      this.group.remove();\n    }\n  }\n\n  /**\n   * Calculate the width that the text rectangle should be set to\n   * @param labelText the label text that will be displayed in the rectangle\n   * @return the width that the text rectangle should be set to\n   */\n  calculateTextRectWidth(labelText) {\n    var width = 0;\n\n    if (labelText != null) {\n      width = (labelText.length * 6) + 10;\n    }\n\n    return width;\n  }\n\n  // end of ConceptMapLink class\n}\n\n\nConceptMapService.$inject = [\n  '$anchorScroll',\n  '$filter',\n  '$location',\n  '$q',\n  '$timeout',\n  'ConfigService',\n  'StudentAssetService',\n  'StudentDataService',\n  'UtilService'\n];\n\nexport default ConceptMapService;\n"]}