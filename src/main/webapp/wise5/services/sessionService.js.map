{"version":3,"sources":["sessionService.es6"],"names":["SessionService","$http","$rootScope","ConfigService","warningVisible","defaultForceLogoutAfterWarningInterval","convertMinutesToSeconds","intervals","calculateIntervals","getConfigParam","showWarningInterval","forceLogoutAfterWarningInterval","checkMouseEventInterval","convertMinutesToMilliseconds","updateLastActivityTimestamp","initializeListeners","initializeSession","sessionTimeout","Math","min","$on","goHome","logOut","wiseBaseURL","getWISEBaseURL","userType","href","getMainHomePageURL","window","location","$broadcast","getSessionLogOutURL","isPreview","startCheckMouseEvent","setInterval","checkMouseEvent","minutes","lastActivityTimestamp","Date","isActiveWithinLastMinute","renewSession","isInactiveLongEnoughToForceLogout","forceLogOut","isInactiveLongEnoughToWarn","isShowingWarning","showWarning","getInactiveTimeInSeconds","floor","getInactiveTimeInMilliseconds","renewSessionURL","get","then","result","$inject"],"mappings":"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","sourcesContent":["class SessionService {\n  constructor($http, $rootScope, ConfigService) {\n    this.$http = $http;\n    this.$rootScope = $rootScope;\n    this.ConfigService = ConfigService;\n    this.warningVisible = false;\n    this.defaultForceLogoutAfterWarningInterval = this.convertMinutesToSeconds(5);\n    const intervals = this.calculateIntervals(this.ConfigService.getConfigParam('sessionTimeout'));\n    this.showWarningInterval = intervals.showWarningInterval;\n    this.forceLogoutAfterWarningInterval = intervals.forceLogoutAfterWarningInterval;\n    this.checkMouseEventInterval = this.convertMinutesToMilliseconds(1);\n    this.updateLastActivityTimestamp();\n    this.initializeListeners();\n    this.initializeSession();\n  }\n\n  calculateIntervals(sessionTimeout) {\n    const forceLogoutAfterWarningInterval = \n        Math.min(sessionTimeout * 0.1, this.defaultForceLogoutAfterWarningInterval);\n    const showWarningInterval = sessionTimeout - forceLogoutAfterWarningInterval;\n    return {\n      showWarningInterval: showWarningInterval,\n      forceLogoutAfterWarningInterval: forceLogoutAfterWarningInterval\n    };\n  }\n\n  initializeListeners() {\n    this.$rootScope.$on('goHome', () => {\n      this.goHome();\n    });\n\n    this.$rootScope.$on('logOut', () => {\n      this.logOut();\n    });\n  }\n\n  goHome() {\n    const wiseBaseURL = this.ConfigService.getWISEBaseURL();\n    const userType = this.ConfigService.getConfigParam('userType');\n    let href = this.ConfigService.getMainHomePageURL();\n    if (userType === 'student') {\n      href = wiseBaseURL + '/student';\n    } else if (userType === 'teacher') {\n      href = wiseBaseURL + '/teacher';\n    }\n    window.location.href = href;\n  }\n\n  logOut() {\n    this.$rootScope.$broadcast('exit');\n    window.location.href = this.ConfigService.getSessionLogOutURL();\n  }\n\n  initializeSession() {\n    if (!this.ConfigService.isPreview()) {\n      this.startCheckMouseEvent();\n    }\n  }\n\n  startCheckMouseEvent() {\n    setInterval(() => { this.checkMouseEvent(); }, this.checkMouseEventInterval);\n  }\n\n  convertMinutesToSeconds(minutes) {\n    return minutes * 60;\n  }\n\n  convertMinutesToMilliseconds(minutes) {\n    return minutes * 60 * 1000;\n  }\n\n  /**\n   * Note: This does not get called when the warning popup is being shown.\n   */\n  mouseMoved() {\n    this.updateLastActivityTimestamp();\n  }\n  \n  updateLastActivityTimestamp() {\n    this.lastActivityTimestamp = new Date();\n  }\n\n  checkMouseEvent() {\n    if (this.isActiveWithinLastMinute()) {\n      this.renewSession();\n    } else if (this.isInactiveLongEnoughToForceLogout()) {\n      this.forceLogOut();\n    } else if (this.isInactiveLongEnoughToWarn() && !this.isShowingWarning()) {\n      this.showWarning();\n    }\n  }\n\n  isActiveWithinLastMinute() {\n    return (new Date() - this.lastActivityTimestamp) < this.convertMinutesToMilliseconds(1);\n  }\n\n  isInactiveLongEnoughToForceLogout() {\n    return this.getInactiveTimeInSeconds() >=\n        (this.showWarningInterval + this.forceLogoutAfterWarningInterval);\n  }\n\n  isInactiveLongEnoughToWarn() {\n    return this.getInactiveTimeInSeconds() >= this.showWarningInterval;\n  }\n\n  isShowingWarning() {\n    return this.warningVisible;\n  }\n\n  getInactiveTimeInSeconds() {\n    return Math.floor(this.getInactiveTimeInMilliseconds() / 1000);\n  }\n\n  getInactiveTimeInMilliseconds() {\n    return new Date() - this.lastActivityTimestamp;\n  }\n\n  forceLogOut() {\n    this.$rootScope.$broadcast('logOut');\n  }\n\n  showWarning() {\n    this.warningVisible = true;\n    this.$rootScope.$broadcast('showSessionWarning');\n  }\n\n  closeWarningAndRenewSession() {\n    this.warningVisible = false;\n    this.updateLastActivityTimestamp();\n    this.renewSession();\n  }\n\n  renewSession() {\n    const renewSessionURL = this.ConfigService.getConfigParam('renewSessionURL');\n    this.$http.get(renewSessionURL).then((result) => {\n\n    });\n  }\n}\n\nSessionService.$inject = [\n  '$http',\n  '$rootScope',\n  'ConfigService'\n];\n\nexport default SessionService;\n"],"file":"sessionService.js"}